<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>mysql 高级 | eric_zht</title><meta name="author" content="eric_zht"><meta name="copyright" content="eric_zht"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="存储过程概述数据库中内置的一种编程语言，可以把多条SQL语句以逻辑代码的方式串联起来执行。 每一个存储过程都是一个数据库对象，就像table和view一样，存储在数据库中，一次编译永久有效。每一个存储过程都有自己的名字，客户端程序通过名字来调用存储过程。 在数据量特别大的情况下使用存储过程能达到倍速的效率提升。 优缺点优点：速度快。   - 降低了**应用服务器**和**数据库服务器**之间网络通">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql 高级">
<meta property="og:url" content="http://example.com/2025/06/02/mysql%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="eric_zht">
<meta property="og:description" content="存储过程概述数据库中内置的一种编程语言，可以把多条SQL语句以逻辑代码的方式串联起来执行。 每一个存储过程都是一个数据库对象，就像table和view一样，存储在数据库中，一次编译永久有效。每一个存储过程都有自己的名字，客户端程序通过名字来调用存储过程。 在数据量特别大的情况下使用存储过程能达到倍速的效率提升。 优缺点优点：速度快。   - 降低了**应用服务器**和**数据库服务器**之间网络通">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/icon.png">
<meta property="article:published_time" content="2025-06-01T16:00:00.000Z">
<meta property="article:modified_time" content="2025-06-04T09:11:43.447Z">
<meta property="article:author" content="eric_zht">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/icon.png"><link rel="shortcut icon" href="/image/favicon.png"><link rel="canonical" href="http://example.com/2025/06/02/mysql%E9%AB%98%E7%BA%A7/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mysql 高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/image/icon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://pic.imgdb.cn/item/6741310cd29ded1a8c7a7799.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">eric_zht</span></a><a class="nav-page-title" href="/"><span class="site-name">mysql 高级</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">mysql 高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-01T16:00:00.000Z" title="发表于 2025-06-02 00:00:00">2025-06-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-04T09:11:43.447Z" title="更新于 2025-06-04 17:11:43">2025-06-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">18.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>66分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>数据库中内置的一种编程语言，可以把多条SQL语句以逻辑代码的方式串联起来执行。</p>
<p>每一个存储过程都是一个数据库对象，就像table和view一样，存储在数据库中，一次编译永久有效。每一个存储过程都有自己的名字，客户端程序通过名字来调用存储过程。</p>
<p>在数据量特别大的情况下使用存储过程能达到倍速的效率提升。</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p>优点：速度快。</p>
<pre><code>  - 降低了**应用服务器**和**数据库服务器**之间网络通讯的开销。尤其在数据量庞大的情况下效果显著。
</code></pre>
<p>缺点：移植性差。编写难度大。维护性差。</p>
<pre><code>  - 每一个数据库都有自己的存储过程的语法规则，这种语法规则不是通用的。一旦使用了存储过程，则数据库产品很难更换，例如：编写了mysql的存储过程，这段代码只能在mysql中运行，无法在oracle数据库中运行。
  - 对于数据库存储过程这种语法来说，没有专业的IDE工具（集成开发环境），所以编码速度较低。自然维护的成本也会较高。
</code></pre>
<p>在实际开发中，存储过程还是很少使用的。只有在系统遇到了性能瓶颈，在进行优化的时候，对于大数量的应用来说，可以考虑使用一些。</p>
<h2 id="第一个存储过程"><a href="#第一个存储过程" class="headerlink" title="第一个存储过程"></a>第一个存储过程</h2><h3 id="存储过程的创建"><a href="#存储过程的创建" class="headerlink" title="存储过程的创建"></a>存储过程的创建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create procedure p1()</span><br><span class="line">begin</span><br><span class="line">	select empno,ename from emp;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<h3 id="存储过程的调用"><a href="#存储过程的调用" class="headerlink" title="存储过程的调用"></a>存储过程的调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call p1();</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=QTP2F&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="存储过程的查看"><a href="#存储过程的查看" class="headerlink" title="存储过程的查看"></a>存储过程的查看</h3><p>查看创建存储过程的语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show create procedure p1;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709126586312-da2680d8-e344-4d29-a380-4e302d7d5a79.png#averageHue=%23fcf8f8&clientId=uc80f783a-0512-4&from=paste&height=168&id=u24887cbe&originHeight=168&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12025&status=done&style=shadow&taskId=u021fb4bd-b421-443e-935b-58d36bbd03a&title=&width=900" alt="image.png"></p>
<p>通过系统表information_schema.ROUTINES查看存储过程的详细信息：<br>information_schema.ROUTINES 是 MySQL 数据库中一个系统表，存储了所有存储过程、函数、触发器的详细信息，包括名称、返回值类型、参数、创建时间、修改时间等。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.routines <span class="keyword">where</span> routine_name <span class="operator">=</span> <span class="string">&#x27;p1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709126989240-620c3611-2f19-42b3-ac8f-a686f5bcb1e5.png#averageHue=%23f8efee&clientId=uc80f783a-0512-4&from=paste&height=201&id=ude40e9fd&originHeight=201&originWidth=1044&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25948&status=done&style=shadow&taskId=u284ef46e-51f6-47e6-b1ea-c9cb7aa5276&title=&width=1044" alt="image.png"></p>
<p>information_schema.ROUTINES 表中的一些重要的列包括：</p>
<ul>
<li>SPECIFIC_NAME：存储过程的具体名称，包括该存储过程的名字，参数列表。</li>
<li>ROUTINE_SCHEMA：存储过程所在的数据库名称。</li>
<li>ROUTINE_NAME：存储过程的名称。</li>
<li>ROUTINE_TYPE：PROCEDURE表示是一个存储过程，FUNCTION表示是一个函数。</li>
<li>ROUTINE_DEFINITION：存储过程的定义语句。</li>
<li>CREATED：存储过程的创建时间。</li>
<li>LAST_ALTERED：存储过程的最后修改时间。</li>
<li>DATA_TYPE：存储过程的返回值类型、参数类型等。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=pmh5m&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="存储过程的删除"><a href="#存储过程的删除" class="headerlink" title="存储过程的删除"></a>存储过程的删除</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists p1;</span><br></pre></td></tr></table></figure>

<h3 id="delimiter命令"><a href="#delimiter命令" class="headerlink" title="delimiter命令"></a>delimiter命令</h3><p>在 MySQL 中，<code>delimiter</code> 命令用于改变 MySQL 解释语句的定界符。MySQL 默认使用分号 <code>;</code> 作为语句的定界符。而使用 <code>delimiter</code> 命令可以将分号 <code>;</code> 更改为其他字符，从而可以在 SQL 语句中使用分号 <code>;</code>。</p>
<p>例如，假设需要创建一个存储过程。在存储过程中通常会包括多条 SQL 语句，而这些语句都需要以分号 <code>;</code> 结尾。但默认情况下，执行到第一条语句的分号 <code>;</code> 后，MySQL 就会停止解释，导致后续的语句无法执行。解决方式就是使用 <code>delimiter</code> 命令将分号改为其他字符，使分号 <code>;</code> 不再是语句定界符。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> my_proc ()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> my_table;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> my_table (col1, col2) <span class="keyword">VALUES</span> (<span class="string">&#x27;value1&#x27;</span>, <span class="string">&#x27;value2&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用 <code>delimiter //</code> 命令将定界符改为两个斜线 <code>//</code>。在存储过程中，以分号 <code>;</code> 结尾的语句不再被解释为语句的结束。而使用 <code>delimiter ;</code> 可以将分号恢复为语句定界符。</p>
<p>总之，<code>delimiter</code> 命令可以改变 MySQL 数据库系统中 SQL 查询语句的分隔符，从而可使一条 SQL 查询语句包含多个 SQL 语句。这样的话，就方便了我们在一个语句里面加入多个语句，而且不会被错</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=phuBi&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="MySQL的变量"><a href="#MySQL的变量" class="headerlink" title="MySQL的变量"></a>MySQL的变量</h2><p>mysql中的变量包括：系统变量、用户变量、局部变量。</p>
<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><p>MySQL 系统变量是指在 MySQL 服务器运行时控制其行为的参数。这些变量可以被设置为特定的值来改变服务器的默认设置，以满足不同的需求。<br>MySQL 系统变量可以具有全局（global）或会话（session）作用域。</p>
<ul>
<li>全局作用域是指对所有连接和所有数据库都适用；</li>
<li>会话作用域是指只对当前连接和当前数据库适用。</li>
</ul>
<p>查看系统变量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span><span class="operator">|</span>session] variables;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> [<span class="keyword">global</span><span class="operator">|</span>session] variables <span class="keyword">like</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @@[<span class="keyword">global</span><span class="operator">|</span>session.]系统变量名;</span><br></pre></td></tr></table></figure>

<p>注意：没有指定session或global时，默认是session。</p>
<p>设置系统变量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> [<span class="keyword">global</span> <span class="operator">|</span> session] 系统变量名 <span class="operator">=</span> 值;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @@[<span class="keyword">global</span> <span class="operator">|</span> session.]系统变量名 <span class="operator">=</span> 值;</span><br></pre></td></tr></table></figure>

<p>注意：无论是全局设置还是会话设置，当mysql服务重启之后，之前配置都会失效。可以通过修改MySQL根目录下的my.ini配置文件达到永久修改的效果。（my.ini是MySQL数据库默认的系统级配置文件，默认是不存在的，需要新建，并参考一些资料进行配置。）<br>windows系统是my.ini<br>linux系统是my.cnf<br>my.ini文件通常放在mysql安装的根目录下，如下图：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709128860158-306db5d6-e5df-41c6-8936-a35ab1df1ab2.png#averageHue=%23fdf9f6&clientId=uc80f783a-0512-4&from=paste&height=235&id=uaa939f07&originHeight=235&originWidth=198&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5032&status=done&style=shadow&taskId=u9937fe52-2196-4484-976d-b76b7d52e29&title=&width=198" alt="image.png"><br>这个文件通常是不存在的，可以新建，新建后例如提供以下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">autocommit=0</span><br></pre></td></tr></table></figure>

<p>这种配置就表示永久性关闭自动提交机制。（不建议这样做。）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=afZ3n&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="用户变量"><a href="#用户变量" class="headerlink" title="用户变量"></a>用户变量</h3><p>用户自定义的变量。只在当前会话有效。所有的用户变量‘@’开始。</p>
<p>给用户变量赋值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@name</span> <span class="operator">=</span> <span class="string">&#x27;jackson&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@age</span> :<span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@gender</span> :<span class="operator">=</span> <span class="string">&#x27;男&#x27;</span>, <span class="variable">@addr</span> :<span class="operator">=</span> <span class="string">&#x27;北京大兴区&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@email</span> :<span class="operator">=</span> <span class="string">&#x27;jackson@123.com&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> sal <span class="keyword">into</span> <span class="variable">@sal</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>读取用户变量的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="variable">@name</span>, <span class="variable">@age</span>, <span class="variable">@gender</span>, <span class="variable">@addr</span>, <span class="variable">@email</span>, <span class="variable">@sal</span>;</span><br></pre></td></tr></table></figure>

<p>注意：mysql中变量不需要声明。直接赋值就行。如果没有声明变量，直接读取该变量，返回null</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=FwLAC&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>在存储过程中可以使用局部变量。使用declare声明。在begin和end之间有效。</p>
<p>变量的声明</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> 变量名 数据类型 [<span class="keyword">default</span> ...];</span><br></pre></td></tr></table></figure>

<p>变量的数据类型就是表字段的数据类型，例如：int、bigint、char、varchar、date、time、datetime等。<br><strong>注意：declare通常出现在begin end之间的开始部分。</strong></p>
<p>变量的赋值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> 变量名 <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">set</span> 变量名 :<span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">select</span> 字段名 <span class="keyword">into</span> 变量名 <span class="keyword">from</span> 表名 ...;</span><br></pre></td></tr></table></figure>

<p>例如：以下程序演示局部变量的声明、赋值、读取：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">PROCEDURE</span> p2()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="comment">/*声明变量*/</span></span><br><span class="line">	<span class="keyword">declare</span> emp_count <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*声明变量*/</span></span><br><span class="line">	<span class="keyword">declare</span> sal <span class="keyword">double</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">default</span> <span class="number">0.0</span>;</span><br><span class="line">	<span class="comment">/*给变量赋值*/</span></span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">into</span> emp_count <span class="keyword">from</span> emp;</span><br><span class="line">	<span class="comment">/*给变量赋值*/</span></span><br><span class="line">	<span class="keyword">set</span> sal :<span class="operator">=</span> <span class="number">5000.0</span>;</span><br><span class="line">	<span class="comment">/*读取变量的值*/</span></span><br><span class="line">	<span class="keyword">select</span> emp_count;</span><br><span class="line">	<span class="comment">/*读取变量的值*/</span></span><br><span class="line">	<span class="keyword">select</span> sal;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> p2();</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=I0d6I&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line">elseif 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line">elseif 条件 <span class="keyword">then</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">end</span> if;</span><br></pre></td></tr></table></figure>

<p>案例：员工月薪sal，超过10000的属于“高收入”，6000到10000的属于“中收入”，少于6000的属于“低收入”。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p3(               )</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> sal <span class="type">int</span> <span class="keyword">default</span> <span class="number">5000</span>;</span><br><span class="line">	<span class="keyword">declare</span> grade <span class="type">varchar</span>(<span class="number">20</span>);</span><br><span class="line">	if sal <span class="operator">&gt;</span> <span class="number">10000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;高收入&#x27;</span>;</span><br><span class="line">	elseif sal <span class="operator">&gt;=</span> <span class="number">6000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;中收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;低收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line">	<span class="keyword">select</span> grade;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> p3();</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=W8NWq&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>存储过程的参数包括三种形式：</p>
<ul>
<li>in：入参（未指定时，默认是in）</li>
<li>out：出参</li>
<li>inout：既是入参，又是出参</li>
</ul>
<p>案例：员工月薪sal，超过10000的属于“高收入”，6000到10000的属于“中收入”，少于6000的属于“低收入”。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p4(<span class="keyword">in</span> sal <span class="type">int</span>, <span class="keyword">out</span> grade <span class="type">varchar</span>(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	if sal <span class="operator">&gt;</span> <span class="number">10000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;高收入&#x27;</span>;</span><br><span class="line">	elseif sal <span class="operator">&gt;=</span> <span class="number">6000</span> <span class="keyword">then</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;中收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">  	<span class="keyword">set</span> grade :<span class="operator">=</span> <span class="string">&#x27;低收入&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> p4(<span class="number">5000</span>, <span class="variable">@grade</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@grade</span>;</span><br></pre></td></tr></table></figure>

<p>案例：将传入的工资sal上调10%</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p5(<span class="keyword">inout</span> sal <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> sal :<span class="operator">=</span> sal <span class="operator">*</span> <span class="number">1.1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@sal</span> :<span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">call</span> p5(<span class="variable">@sal</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@sal</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=jV9Mv&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="case语句"><a href="#case语句" class="headerlink" title="case语句"></a>case语句</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> 值</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 值<span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	......</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span></span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">when</span> 条件<span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	......</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">case</span>;</span><br></pre></td></tr></table></figure>

<p>案例：根据不同月份，输出不同的季节。3 4 5月份春季。6 7 8月份夏季。9 10 11月份秋季。12 1 2 冬季。其他非法。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> <span class="keyword">month</span> <span class="type">int</span>, <span class="keyword">out</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">month</span></span><br><span class="line">		<span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">6</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">7</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">8</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">9</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">10</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">11</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">12</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;非法月份&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> <span class="keyword">month</span> <span class="type">int</span>, <span class="keyword">out</span> <span class="keyword">result</span> <span class="type">varchar</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">case</span> </span><br><span class="line">		<span class="keyword">when</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">3</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">4</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;春季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">6</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">7</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">8</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;夏季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">9</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">10</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">11</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;秋季&#x27;</span>;</span><br><span class="line">		<span class="keyword">when</span>  <span class="keyword">month</span> <span class="operator">=</span> <span class="number">12</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">2</span>  <span class="keyword">then</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;冬季&#x27;</span>;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">			<span class="keyword">set</span> <span class="keyword">result</span> :<span class="operator">=</span> <span class="string">&#x27;非法月份&#x27;</span>;</span><br><span class="line">	<span class="keyword">end</span> <span class="keyword">case</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">9</span>, <span class="variable">@season</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@season</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=I1Dju&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while 条件 do</span><br><span class="line">	循环体;</span><br><span class="line"><span class="keyword">end</span> while;</span><br></pre></td></tr></table></figure>

<p>案例：传入一个数字n，计算1~n中所有偶数的和。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> n <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> sum <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	while n <span class="operator">&gt;</span> <span class="number">0</span> do</span><br><span class="line">  		if n <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    		<span class="keyword">set</span> sum :<span class="operator">=</span> sum <span class="operator">+</span> n;</span><br><span class="line">  		<span class="keyword">end</span> if;</span><br><span class="line">  		<span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">end</span> while;</span><br><span class="line">	<span class="keyword">select</span> sum;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=QCtLl&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="repeat循环"><a href="#repeat循环" class="headerlink" title="repeat循环"></a>repeat循环</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repeat</span><br><span class="line">	循环体;</span><br><span class="line">	until 条件</span><br><span class="line"><span class="keyword">end</span> repeat;</span><br></pre></td></tr></table></figure>

<p>注意：条件成立时结束循环。</p>
<p>案例：传入一个数字n，计算1~n中所有偶数的和。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro(<span class="keyword">in</span> n <span class="type">int</span>, <span class="keyword">out</span> sum <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">set</span> sum :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	repeat </span><br><span class="line">		if n <span class="operator">%</span> <span class="number">2</span> <span class="operator">=</span> <span class="number">0</span> <span class="keyword">then</span> </span><br><span class="line">		  <span class="keyword">set</span> sum :<span class="operator">=</span> sum <span class="operator">+</span> n;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">set</span> n :<span class="operator">=</span> n <span class="operator">-</span> <span class="number">1</span>;</span><br><span class="line">		until n <span class="operator">&lt;=</span> <span class="number">0</span></span><br><span class="line">	<span class="keyword">end</span> repeat;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> mypro(<span class="number">10</span>, <span class="variable">@sum</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@sum</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=wRsAn&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="loop循环"><a href="#loop循环" class="headerlink" title="loop循环"></a>loop循环</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  mylp:loop </span><br><span class="line">		<span class="keyword">set</span> i :<span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			leave mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">select</span> i;</span><br><span class="line">	<span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> mypro()</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">  mylp:loop </span><br><span class="line">		<span class="keyword">set</span> i :<span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">5</span> <span class="keyword">then</span> </span><br><span class="line">			iterate mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		if i <span class="operator">=</span> <span class="number">10</span> <span class="keyword">then</span> </span><br><span class="line">		  leave mylp;</span><br><span class="line">		<span class="keyword">end</span> if;</span><br><span class="line">		<span class="keyword">select</span> i;</span><br><span class="line">	<span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=VDJ87&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="游标cursor"><a href="#游标cursor" class="headerlink" title="游标cursor"></a>游标cursor</h2><p>游标（cursor）可以理解为一个指向结果集中某条记录的指针，允许程序逐一访问结果集中的每条记录，并对其进行逐行操作和处理。</p>
<p>使用游标时，需要在存储过程或函数中定义一个游标变量，并通过 <code>DECLARE</code> 语句进行声明和初始化。然后，使用 <code>OPEN</code> 语句打开游标，使用 <code>FETCH</code> 语句逐行获取游标指向的记录，并进行处理。最后，使用 <code>CLOSE</code> 语句关闭游标，释放相关资源。游标可以大大地提高数据库查询的灵活性和效率。</p>
<p>声明游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> 游标名称 <span class="keyword">cursor</span> <span class="keyword">for</span> 查询语句;</span><br></pre></td></tr></table></figure>

<p>打开游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> 游标名称;</span><br></pre></td></tr></table></figure>

<p>通过游标取数据的语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fetch</span> 游标名称 <span class="keyword">into</span> 变量[,变量,变量......]</span><br></pre></td></tr></table></figure>

<p>关闭游标的语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">close</span> 游标名称;</span><br></pre></td></tr></table></figure>

<p>案例：从dept表查询部门编号和部门名，创建一张新表dept2，将查询结果插入到新表中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists mypro;</span><br><span class="line"></span><br><span class="line">create procedure mypro()</span><br><span class="line">begin </span><br><span class="line"></span><br><span class="line">	declare no int;</span><br><span class="line">	declare name varchar(100);</span><br><span class="line">	/* 声明游标 */</span><br><span class="line">	declare dept_cursor cursor for select deptno,dname from dept;</span><br><span class="line"></span><br><span class="line">	drop table if exists dept2;</span><br><span class="line">	create table dept2(</span><br><span class="line">		no int primary key,</span><br><span class="line">		name varchar(100)</span><br><span class="line">	);</span><br><span class="line">	/* 打开游标 */</span><br><span class="line">	open dept_cursor;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	while true do</span><br><span class="line">	/* 使用游标抓取内容到变量中 */</span><br><span class="line">		fetch dept_cursor into no, name;</span><br><span class="line">		insert into dept2(no,name) values(no,name);</span><br><span class="line">	end while;</span><br><span class="line">	/* 关闭游标 */</span><br><span class="line">	close dept_cursor;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">call mypro();</span><br></pre></td></tr></table></figure>

<p>执行结果：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687222276547-6381cff6-311f-40a0-984c-0a79f6954a50.png#averageHue=%23fbfaf9&clientId=ua8e0f13a-20b6-4&from=paste&height=78&id=u0eb9a0cb&originHeight=78&originWidth=392&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1792&status=done&style=shadow&taskId=u26df3d97-46f1-47c0-b98c-64e8715dea4&title=&width=392" alt="image.png"><br>出现了异常：异常信息中显示没有数据了。这是因为while true循环导致的。</p>
<p>不过虽然出现了异常，但是表创建成功了，数据也插入成功了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687222354577-99ea5bb0-40c8-4bca-9a9a-605894b195bb.png#averageHue=%23f4f3f2&clientId=ua8e0f13a-20b6-4&from=paste&height=243&id=u5e8d1f82&originHeight=243&originWidth=360&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12923&status=done&style=shadow&taskId=u4100f2d2-0b52-4976-8711-96d5e9ab89d&title=&width=360" alt="image.png"><br><strong>注意：声明局部变量和声明游标有顺序要求，局部变量的声明需要在游标声明之前完成。</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=msB7t&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="捕捉异常并处理"><a href="#捕捉异常并处理" class="headerlink" title="捕捉异常并处理"></a>捕捉异常并处理</h2><p>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE handler_name HANDLER FOR condition_value action_statement</span><br></pre></td></tr></table></figure>

<ol>
<li>handler_name 表示异常处理程序的名称，重要取值包括：<ol>
<li>CONTINUE：发生异常后，程序不会终止，会正常执行后续的过程。(捕捉)</li>
<li>EXIT：发生异常后，终止存储过程的执行。（上抛）</li>
</ol>
</li>
<li>condition_value 是指捕获的异常，重要取值包括：<ol>
<li>SQLSTATE sqlstate_value，例如：SQLSTATE ‘02000’</li>
<li>SQLWARNING，代表所有01开头的SQLSTATE</li>
<li>NOT FOUND，代表所有02开头的SQLSTATE</li>
<li>SQLEXCEPTION，代表除了01和02开头的所有SQLSTATE</li>
</ol>
</li>
<li>action_statement 是指异常发生时执行的语句，例如：CLOSE cursor_name</li>
</ol>
<p>给之前的游标添加异常处理机制：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists mypro;</span><br><span class="line"></span><br><span class="line">create procedure mypro()</span><br><span class="line">begin </span><br><span class="line"></span><br><span class="line">	declare no int;</span><br><span class="line">	declare name varchar(100);</span><br><span class="line">	declare dept_cursor cursor for select deptno,dname from dept;</span><br><span class="line"></span><br><span class="line">	declare exit handler for not found close dept_cursor;</span><br><span class="line"></span><br><span class="line">	drop table if exists dept2;</span><br><span class="line">	create table dept2(</span><br><span class="line">		no int primary key,</span><br><span class="line">		name varchar(100)</span><br><span class="line">	);</span><br><span class="line">	</span><br><span class="line">	open dept_cursor;</span><br><span class="line">	</span><br><span class="line">	while true do</span><br><span class="line">		fetch dept_cursor into no, name;</span><br><span class="line">		insert into dept2(no,name) values(no,name);</span><br><span class="line">	end while;</span><br><span class="line">	</span><br><span class="line">	close dept_cursor;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">call mypro();</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=yprEz&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h2><p>存储函数：带返回值的存储过程。参数只允许是in（但不能写显示的写in）。没有out，也没有inout。<br>语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE FUNCTION 存储函数名称(参数列表) RETURNS 数据类型 [特征]</span><br><span class="line">BEGIN</span><br><span class="line">	--函数体</span><br><span class="line">	RETURN ...;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>“特征”的可取重要值如下：</p>
<ul>
<li>deterministic：用该特征标记该函数为确定性函数（什么是确定性函数？每次调用函数时传同一个参数的时候，返回值都是固定的）。这是一种优化策略，这种情况下整个函数体的执行就会省略了，直接返回之前缓存的结果，来提高函数的执行效率。</li>
<li>no sql：用该特征标记该函数执行过程中不会查询数据库，如果确实没有查询语句建议使用。告诉 MySQL 优化器不需要考虑使用查询缓存和优化器缓存来优化这个函数，这样就可以避免不必要的查询消耗产生，从而提高性能。</li>
<li>reads sql data：用该特征标记该函数会进行查询操作，告诉 MySQL 优化器这个函数需要查询数据库的数据，可以使用查询缓存来缓存结果，从而提高查询性能；同时 MySQL 还会针对该函数的查询进行优化器缓存处理。</li>
</ul>
<p>案例：计算1~n的所有偶数之和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-- 删除函数</span><br><span class="line">drop function if exists sum_fun;</span><br><span class="line"></span><br><span class="line">-- 创建函数</span><br><span class="line">create function sum_fun(n int)</span><br><span class="line">returns int deterministic </span><br><span class="line">begin </span><br><span class="line">	declare result int default 0;</span><br><span class="line">	while n &gt; 0 do </span><br><span class="line">		if n % 2 = 0 then </span><br><span class="line">			set result := result + n;</span><br><span class="line">		end if;</span><br><span class="line">		set n := n - 1;</span><br><span class="line">	end while;</span><br><span class="line">	return result;</span><br><span class="line">end;</span><br><span class="line"></span><br><span class="line">-- 调用函数</span><br><span class="line">set @result = sum_fun(100);</span><br><span class="line">select @result;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=bhVWz&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><p>MySQL 触发器是一种数据库对象，它是与表相关联的特殊程序。它可以在特定的数据操作（例如插入（INSERT）、更新（UPDATE）或删除（DELETE））触发时自动执行。MySQL 触发器使数据库开发人员能够在数据的不同状态之间维护一致性和完整性，并且可以为特定的数据库表自动执行操作。</p>
<p>触发器的作用主要有以下几个方面：</p>
<ol>
<li>强制实施业务规则：触发器可以帮助确保数据表中的业务规则得到强制执行，例如检查插入或更新的数据是否符合某些规则。 </li>
<li>数据审计：触发器可以声明在执行数据修改时自动记日志或审计数据变化的操作，使数据对数据库管理员和 SQL 审计人员更易于追踪和审计。 </li>
<li>执行特定业务操作：触发器可以自动执行特定的业务操作，例如计算数据行的总数、计算平均值或总和等。</li>
</ol>
<p>MySQL 触发器分为两种类型: BEFORE 和 AFTER。BEFORE 触发器在执行 INSERT、UPDATE、DELETE 语句之前执行，而 AFTER 触发器在执行 INSERT、UPDATE、DELETE 语句之后执行。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=oK2pn&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p>创建触发器的语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER trigger_name</span><br><span class="line">BEFORE/AFTER INSERT/UPDATE/DELETE ON table_name FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">-- 触发器执行的 SQL 语句</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>trigger_name：触发器的名称</li>
<li>BEFORE&#x2F;AFTER：触发器的类型，可以是 BEFORE 或者 AFTER</li>
<li>INSERT&#x2F;UPDATE&#x2F;DELETE：触发器所监控的 DML 调用类型</li>
<li>table_name：触发器所绑定的表名</li>
<li>FOR EACH ROW：表示触发器在每行受到 DML 的影响之后都会执行</li>
<li>触发器执行的 SQL 语句：该语句会在触发器被触发时执行</li>
</ul>
<p>需要注意的是，触发器是一种高级的数据库功能，只有在必要的情况下才应该使用，例如在需要实施强制性业务规则时。过多的触发器和复杂的触发器逻辑可能会影响查询性能和扩展性。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=QGPl6&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p><strong>关于触发器的NEW和OLD关键字：</strong><br>在 MySQL 触发器中，NEW 和 OLD 是两个特殊的关键字，用于引用在触发器中受到修改的行的新值和旧值。具体而言：</p>
<ul>
<li>NEW：在触发 INSERT 或 UPDATE 操作期间，NEW 用于引用将要插入或更新到表中的新行的值。</li>
<li>OLD：在触发 UPDATE 或 DELETE 操作期间，OLD 用于引用更新或删除之前在表中的旧行的值。</li>
</ul>
<p>通俗的讲，NEW 是指触发器执行的操作所要插入或更新到当前行中的新数据；而 OLD 则是指当前行在触发器执行前原本的数据。</p>
<p>在MySQL 触发器中，NEW 和 OLD 使用方法是相似的。在触发器中，可以像引用表的其他列一样引用 NEW 和 OLD。例如，可以使用 OLD.column_name 从旧行中引用列值，也可以使用 NEW.column_name 从新行中引用列值。</p>
<p>示例：</p>
<p>假设有一个名为 my_table 的表，其中包含一个名为 quantity 的列。当在该表上执行 UPDATE 操作时，以下触发器会将旧值 OLD.quantity 累加到新值 NEW.quantity 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER my_trigger</span><br><span class="line">BEFORE UPDATE ON my_table</span><br><span class="line">FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">SET NEW.quantity = NEW.quantity + OLD.quantity;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<p>在此触发器中，OLD.quantity 引用原始行的 quantity 值（旧值），而 NEW.quantity 引用更新行的 quantity 值（新值）。在触发器执行期间，数据行的 quantity 值将设置为旧值加上新值。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=LJmEa&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p>需要注意的是，在使用 NEW 和 OLD 时，需要根据 DML 操作的类型进行判断，以确定哪个关键字表示新值，哪个关键字则表示旧值。</p>
<p>案例：当我们对dept表中的数据进行insert delete update的时候，请将这些操作记录到日志表当中，日志表如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> oper_log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> oper_log(</span><br><span class="line">  id <span class="type">bigint</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  table_name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的哪张表&#x27;</span>,</span><br><span class="line">  oper_type <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作类型包括insert delete update&#x27;</span>,</span><br><span class="line">  oper_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">  oper_id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的那行记录的id&#x27;</span>,</span><br><span class="line">  oper_desc text comment <span class="string">&#x27;操作描述&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>触发器1：向dept表中插入数据时，记录日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create trigger dept_trigger_insert </span><br><span class="line">after insert on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;insert&#x27;,now(),new.deptno,concat(&#x27;插入数据：deptno=&#x27;, new.deptno, &#x27;,dname=&#x27;, new.dname,&#x27;,loc=&#x27;, new.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=M5q7i&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p>查看触发器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show triggers;</span><br></pre></td></tr></table></figure>

<p>删除触发器：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> if <span class="keyword">exists</span> dept_trigger_insert;</span><br></pre></td></tr></table></figure>

<p>向dept表中插入一条记录：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687250537958-36fdd3ce-6aa3-48e9-aa34-39dac470c82f.png#averageHue=%23f2f0ed&clientId=ua8e0f13a-20b6-4&from=paste&height=254&id=u2d5b23b7&originHeight=254&originWidth=327&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14090&status=done&style=shadow&taskId=u0b945c07-f0a0-4c61-b2e3-a27a514ddb8&title=&width=327" alt="image.png"><br>日志表中多了一条记录：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687250572044-f7216711-ee12-49bf-b687-b21b7b5856cd.png#averageHue=%23f3f1f0&clientId=ua8e0f13a-20b6-4&from=paste&height=145&id=u94fbdc8c&originHeight=145&originWidth=1014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15305&status=done&style=shadow&taskId=u7fad2861-b2e6-4220-af3e-0a22c454cf0&title=&width=1014" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=ysgPX&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p>触发器2：修改dept表中数据时，记录日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create trigger dept_trigger_update</span><br><span class="line">after update on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;update&#x27;,now(),new.deptno,concat(&#x27;更新前：deptno=&#x27;, old.deptno, &#x27;,dname=&#x27;, old.dname,&#x27;,loc=&#x27;, old.loc, </span><br><span class="line">                                              &#x27;,更新后：deptno=&#x27;, new.deptno, &#x27;,dname=&#x27;, new.dname,&#x27;,loc=&#x27;, new.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>更新一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> dept <span class="keyword">set</span> loc <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span> <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<p>日志表中多了一条记录：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687250964502-f6af7d92-c4a5-4910-9efa-d08090647643.png#averageHue=%23f5f4f3&clientId=ua8e0f13a-20b6-4&from=paste&height=186&id=u505e3af3&originHeight=186&originWidth=1237&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19556&status=done&style=shadow&taskId=u9ffa318a-67b1-477d-b3c7-851a438b483&title=&width=1237" alt="image.png"><br><strong>注意：更新一条记录则对应一条日志。如果一次更新3条记录，那么日志表中插入3条记录。</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=tfiQK&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<p>触发器3：删除dept表中数据时，记录日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create trigger dept_trigger_delete</span><br><span class="line">after delete on dept</span><br><span class="line">for each row</span><br><span class="line">begin</span><br><span class="line">	insert into oper_log(id,table_name,oper_type,oper_time,oper_id,oper_desc) values</span><br><span class="line">(null,&#x27;dept&#x27;,&#x27;delete&#x27;,now(),old.deptno,concat(&#x27;删除了数据：deptno=&#x27;, old.deptno, &#x27;,dname=&#x27;, old.dname,&#x27;,loc=&#x27;, old.loc));</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>删除一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> dept <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<p>日志表中多了一条记录：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1687251196650-5527bf1a-370d-47c8-bf45-2b7babc5e1a5.png#averageHue=%23f4f3f1&clientId=ua8e0f13a-20b6-4&from=paste&height=186&id=u7fa2da22&originHeight=186&originWidth=1282&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22331&status=done&style=shadow&taskId=u82995139-6935-439b-b17e-5232b0195cf&title=&width=1282" alt="image.png"></p>
<h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>MySQL存储引擎决定了数据在磁盘上的存储方式和访问方式。不同的存储引擎实现了不同的存储和检索算法，因此它们在处理和管理数据的方式上存在差异。</p>
<p>MySQL常见的存储引擎包括InnoDB、MyISAM、Memory、Archive等。每个存储引擎都有自己的特点和适用场景。</p>
<p>例如，</p>
<ul>
<li>InnoDB引擎支持事务和行级锁定，适用于需要高并发读写的应用；</li>
<li>MyISAM引擎不支持事务，但适用于读操作较多的应用；</li>
<li>Memory引擎数据全部存储在内存中，适用于对读写速度要求很高的应用等等。</li>
</ul>
<p>选择适合的存储引擎可以提高MySQL的性能和效率，并且根据应用需求来合理选择存储引擎可以提供更好的数据管理和查询功能。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=M5q7i&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="MySQL支持哪些存储引擎"><a href="#MySQL支持哪些存储引擎" class="headerlink" title="MySQL支持哪些存储引擎"></a>MySQL支持哪些存储引擎</h2><p>使用<code>show engines \G;</code>命令可以查看所有的存储引擎：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">      Engine: MEMORY</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Hash based, stored in memory, useful <span class="keyword">for</span> temporary tables</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">2.</span> row ***************************</span><br><span class="line">      Engine: MRG_MYISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Collection of identical MyISAM tables</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">3.</span> row ***************************</span><br><span class="line">      Engine: CSV</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: CSV storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">4.</span> row ***************************</span><br><span class="line">      Engine: FEDERATED</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: Federated MySQL storage engine</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br><span class="line">*************************** <span class="number">5.</span> row ***************************</span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">6.</span> row ***************************</span><br><span class="line">      Engine: MyISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: MyISAM storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">7.</span> row ***************************</span><br><span class="line">      Engine: InnoDB</span><br><span class="line">     Support: DEFAULT</span><br><span class="line">     Comment: Supports transactions, row-level locking, and foreign keys</span><br><span class="line">Transactions: YES</span><br><span class="line">          XA: YES</span><br><span class="line">  Savepoints: YES</span><br><span class="line">*************************** <span class="number">8.</span> row ***************************</span><br><span class="line">      Engine: ndbinfo</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: MySQL Cluster system information storage engine</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br><span class="line">*************************** <span class="number">9.</span> row ***************************</span><br><span class="line">      Engine: BLACKHOLE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: /dev/<span class="literal">null</span> storage <span class="title function_">engine</span> <span class="params">(anything you write to it disappears)</span></span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">10.</span> row ***************************</span><br><span class="line">      Engine: ARCHIVE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Archive storage engine</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">*************************** <span class="number">11.</span> row ***************************</span><br><span class="line">      Engine: ndbcluster</span><br><span class="line">     Support: NO</span><br><span class="line">     Comment: Clustered, fault-tolerant tables</span><br><span class="line">Transactions: NULL</span><br><span class="line">          XA: NULL</span><br><span class="line">  Savepoints: NULL</span><br></pre></td></tr></table></figure>

<p><code>Support</code>是<code>Yes</code>的表示支持该存储引擎。当前MySQL的版本是<code>8.0.33</code><br>MySQL默认的存储引擎是：<code>InnoDB</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=SagiX&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="指定和修改存储引擎"><a href="#指定和修改存储引擎" class="headerlink" title="指定和修改存储引擎"></a>指定和修改存储引擎</h2><h3 id="指定存储引擎"><a href="#指定存储引擎" class="headerlink" title="指定存储引擎"></a>指定存储引擎</h3><p>在MySQL中，你可以在创建表时指定使用的存储引擎。通过在CREATE TABLE语句中使用ENGINE关键字，你可以指定要使用的存储引擎。</p>
<p>以下是指定存储引擎的示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> my_table (column1 <span class="type">INT</span>, column2 <span class="type">VARCHAR</span>(<span class="number">50</span>)) ENGINE <span class="operator">=</span> InnoDB;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们创建了一个名为my_table的表，并指定了使用InnoDB存储引擎。</p>
<p>如果你不显式指定存储引擎，MySQL将使用默认的存储引擎。默认情况下，MySQL 8的默认存储引擎是InnoDB。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=GDROH&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="修改存储引擎"><a href="#修改存储引擎" class="headerlink" title="修改存储引擎"></a>修改存储引擎</h3><p>在MySQL中，你可以通过ALTER TABLE语句修改表的存储引擎。下面是修改存储引擎的示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> my_table ENGINE <span class="operator">=</span> MyISAM;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，我们使用ALTER TABLE语句将my_table表的存储引擎修改为MyISAM。</p>
<p>请注意，在修改存储引擎之前，你需要考虑以下几点：</p>
<ol>
<li>修改存储引擎可能需要执行复制表的操作，因此可能会造成数据的丢失或不可用。确保在执行修改之前备份你的数据。 </li>
<li>不是所有的存储引擎都支持相同的功能。要确保你选择的新存储引擎支持你应用程序所需的功能。 </li>
<li>修改表的存储引擎可能会影响到现有的应用程序和查询。确保在修改之前评估和测试所有的影响。 </li>
<li>ALTER TABLE语句可能需要适当的权限才能执行。确保你拥有足够的权限来执行修改存储引擎的操作。</li>
</ol>
<p>总而言之，修改存储引擎需要谨慎进行，且需要考虑到可能的影响和风险。建议在进行修改之前进行适当的测试和备份。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=zd3z2&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="常用的存储引擎及适用场景"><a href="#常用的存储引擎及适用场景" class="headerlink" title="常用的存储引擎及适用场景"></a>常用的存储引擎及适用场景</h2><p>在实际开发中，以下存储引擎是比较常用的：</p>
<ol>
<li>InnoDB：<ol>
<li>MySQL默认的事务型存储引擎</li>
<li>支持ACID事务</li>
<li>具有较好的并发性能和数据完整性</li>
<li>支持行级锁定。</li>
<li>适用于大多数应用场景，尤其是需要事务支持的应用。</li>
</ol>
</li>
<li>MyISAM：<ol>
<li>是MySQL早期版本中常用的存储引擎</li>
<li>支持全文索引和表级锁定</li>
<li>不支持事务</li>
<li>由于其简单性和高性能，在某些特定的应用场景中会得到广泛应用，如<strong>读密集</strong>的应用。</li>
</ol>
</li>
<li>MEMORY：<ol>
<li>称为HEAP，是将表存储在内存中的存储引擎</li>
<li>具有非常高的读写性能，但数据会在服务器重启时丢失。</li>
<li>适用于需要快速读写的临时数据集、缓存和临时表等场景。</li>
</ol>
</li>
<li>CSV：<ol>
<li>将数据以纯文本格式存储的存储引擎</li>
<li>适用于需要处理和导入&#x2F;导出CSV格式数据的场景。</li>
</ol>
</li>
<li>ARCHIVE：<ol>
<li>将数据高效地进行压缩和存储的存储引擎</li>
<li>适用于需要长期存储大量历史数据且不经常查询的场景。</li>
</ol>
</li>
</ol>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="什么是索引"><a href="#什么是索引" class="headerlink" title="什么是索引"></a>什么是索引</h2><p>索引是一种能够提高检索（查询）效率的提前排好序的数据结构。例如：书的目录就是一种索引机制。索引是解决SQL慢查询的一种方式。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=M5q7i&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="索引的创建和删除"><a href="#索引的创建和删除" class="headerlink" title="索引的创建和删除"></a>索引的创建和删除</h2><h3 id="主键会自动添加索引"><a href="#主键会自动添加索引" class="headerlink" title="主键会自动添加索引"></a>主键会自动添加索引</h3><p>主键字段会自动添加索引，不需要程序员干涉，主键字段上的索引被称为<code>主键索引</code></p>
<h3 id="unique约束的字段自动添加索引"><a href="#unique约束的字段自动添加索引" class="headerlink" title="unique约束的字段自动添加索引"></a>unique约束的字段自动添加索引</h3><p>unique约束的字段也会自动添加索引，不需要程序员干涉，这种字段上添加的索引称为<code>唯一索引</code></p>
<h3 id="给指定的字段添加索引"><a href="#给指定的字段添加索引" class="headerlink" title="给指定的字段添加索引"></a>给指定的字段添加索引</h3><p>建表时添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp (</span><br><span class="line">    ...</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    ...</span><br><span class="line">    INDEX idx_name (name)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果表已经创建好了，后期给字段添加索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp <span class="keyword">ADD</span> INDEX idx_name (name);</span><br></pre></td></tr></table></figure>

<p>也可以这样添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name <span class="keyword">on</span> emp(name);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=OFevc&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="删除指定字段上的索引"><a href="#删除指定字段上的索引" class="headerlink" title="删除指定字段上的索引"></a>删除指定字段上的索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp <span class="keyword">DROP</span> INDEX idx_name;</span><br></pre></td></tr></table></figure>

<h3 id="查看某张表上添加了哪些索引"><a href="#查看某张表上添加了哪些索引" class="headerlink" title="查看某张表上添加了哪些索引"></a>查看某张表上添加了哪些索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> 表名;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=w26mL&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h2><p>不同的<code>存储引擎</code>有不同的索引类型和实现：</p>
<ul>
<li>按照数据结构分类：<ul>
<li>B+树 索引（mysql的InnoDB存储引擎采用的就是这种索引）采用 B+树  的数据结构</li>
<li>Hash 索引（仅 <code>memory</code> 存储引擎支持）：采用  哈希表  的数据结构</li>
</ul>
</li>
<li>按照物理存储分类：<ul>
<li>聚集索引：索引和表中数据在一起，数据存储的时候就是按照索引顺序存储的。一张表只能有一个聚集索引。</li>
<li>非聚集索引：索引和表中数据是分开的，索引是独立于表空间的，一张表可以有多个非聚集索引。</li>
</ul>
</li>
<li>按照字段特性分类：<ul>
<li>主键索引（primary key）</li>
<li>唯一索引（unique）</li>
<li>普通索引（index）</li>
<li>全文索引（fulltext：仅 <code>InnoDB和MyISAM</code> 存储引擎支持）</li>
</ul>
</li>
<li>按照字段个数分类：<ul>
<li>单列索引、联合索引（也叫复合索引、组合索引）</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=sRH8v&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="MySQL索引采用了B-树数据结构"><a href="#MySQL索引采用了B-树数据结构" class="headerlink" title="MySQL索引采用了B+树数据结构"></a>MySQL索引采用了B+树数据结构</h2><p>常见的树相关的数据结构包括：</p>
<ul>
<li>二叉树</li>
<li>红黑树</li>
<li>B树</li>
<li>B+树</li>
</ul>
<p>区别：树的高度不同。树的高度越低，性能越高。这是因为每一个节点都是一次I&#x2F;O</p>
<h3 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h3><p>有这样一张表<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692335600473-ad5b7cde-e554-47ab-b42f-58168c989893.png#averageHue=%23f2f1ed&clientId=ua5acc0fc-19f8-4&from=paste&height=441&id=u5cc24e34&originHeight=441&originWidth=339&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3982&status=done&style=shadow&taskId=u77e1a6e5-6e8f-4634-93e0-83a562d38d4&title=&width=339" alt="image.png"><br>如果不给id字段添加索引，默认进行全表扫描，假设查询id&#x3D;10的数据，那至少要进行10次磁盘IO。效率低。可以给id字段添加索引，假设该索引使用了二叉树这种数据结构，这个二叉树是这样的（<strong>推荐一个数据结构可视化网站Data Structure Visualizations，是旧金山大学（USFCA）的一个网站</strong>）：<a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">https://www.cs.usfca.edu/~galles&#x2F;visualization&#x2F;Algorithms.html</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692336231981-96990a24-7475-48a4-ba48-decb2ec2c187.png#averageHue=%23ffffff&clientId=ua5acc0fc-19f8-4&from=paste&height=332&id=uac007731&originHeight=332&originWidth=344&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16469&status=done&style=shadow&taskId=ubbc87a88-ba88-4fb3-b41a-8b64f2254d2&title=&width=344" alt="image.png"><br>如果这个时候要找id&#x3D;10的数据，需要的IO次数是？4次。效率显著提升了。<br>但是MySQL并没有直接使用这种普通的二叉树，这种普通二叉树在<code>数据极端</code>的情况下，效率较低。比如下面的数据：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692336431647-e5bb092a-7858-478b-add5-d4c5fa15deb0.png#averageHue=%23f2f1ee&clientId=ua5acc0fc-19f8-4&from=paste&height=441&id=u3b726904&originHeight=441&originWidth=339&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3789&status=done&style=shadow&taskId=ua2ac59c3-fe8c-4a82-b75a-f816e66b541&title=&width=339" alt="image.png"><br>如果给id字段添加索引，并且该索引底层使用了普通二叉树，这棵树会是这样的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692336585274-554cb4fd-3d32-4785-89c9-e23bce8739ac.png#averageHue=%23ffffff&clientId=ua5acc0fc-19f8-4&from=paste&height=480&id=u6374ad1c&originHeight=480&originWidth=304&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19184&status=done&style=shadow&taskId=u400302da-6c48-46d2-b8ae-d72f2654b84&title=&width=304" alt="image.png"><br>你虽然使用了二叉树，但这更像一个链表。查找效率等同于链表查询O(n)【<strong>查找算法的时间复杂度是线性的</strong>】。查找效率极低。<br>因此对于MySQL来说，它并没有选择这种数据结构作为索引。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=sEgbs&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="红黑树（自平衡二叉树）"><a href="#红黑树（自平衡二叉树）" class="headerlink" title="红黑树（自平衡二叉树）"></a>红黑树（自平衡二叉树）</h3><p>通过自旋平衡规则进行旋转，子节点会自动分叉为2个分支，从而减少树的高度，当数据有序插入时比二叉树数据检索性能更好。<br>例如有以下数据<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692336431647-e5bb092a-7858-478b-add5-d4c5fa15deb0.png#averageHue=%23f2f1ee&clientId=ua5acc0fc-19f8-4&from=paste&height=441&id=T4nMk&originHeight=441&originWidth=339&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3789&status=done&style=shadow&taskId=ua2ac59c3-fe8c-4a82-b75a-f816e66b541&title=&width=339" alt="image.png"><br>给id字段添加索引，并且该索引使用了<code>红黑树</code>数据结构，那么会是这样：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692337568497-9cec3d01-cb4b-4b9f-85a5-763315fc1953.png#averageHue=%23f7f5f5&clientId=ua5acc0fc-19f8-4&from=paste&height=301&id=ub8076d75&originHeight=301&originWidth=572&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16097&status=done&style=shadow&taskId=u6a5b156c-5849-4f84-8637-8ceb1493fa3&title=&width=572" alt="image.png"><br>如果查找id&#x3D;10的数据，磁盘IO次数为：5次。效率比普通二叉树要高一些。</p>
<p>但是如果数据量庞大，例如500万条数据，也会导致树的高度很高，磁盘IO次数仍然很多，查询效率也会比较低。</p>
<p>因此MySQL并没有使用红黑树这种数据结构作为索引。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=YnDdz&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="B-Trees（B树）"><a href="#B-Trees（B树）" class="headerlink" title="B Trees（B树）"></a>B Trees（B树）</h3><p>B Trees首先是一个<code>自平衡</code>的。<br>B Trees每个节点下的子节点数量 &gt; 2。<br>B Trees每个节点中也不是存储单个数据，可以存储多个数据。<br>B Trees又称为<code>平衡多路查找树</code>。</p>
<p>B Trees分支的数量不是2，是大于2，具体是多少个分支，由<code>阶</code>决定。例如：</p>
<ul>
<li>3阶的B Trees，一个节点下最多有3个子节点，每个节点中最多有2个数据。</li>
<li>4阶的B Trees，一个节点下最多有4个子节点，每个节点中最多有3个数据。</li>
<li>5阶（5, 4）</li>
<li>6阶（6, 5）</li>
<li>….</li>
<li>16阶（16, 15）【MySQL采用了16阶】</li>
</ul>
<p>采用B Trees，你会发现相同的数据量，<strong>B Tree 树的高度更低</strong>。磁盘IO次数更少。<br>3阶的B Trees：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692341860428-41d05ad9-1a6a-46ca-b3ae-0a411999152b.png#averageHue=%23e1b333&clientId=ua5acc0fc-19f8-4&from=paste&height=369&id=ufaaa8101&originHeight=369&originWidth=777&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22246&status=done&style=shadow&taskId=u48c7b5a4-1c35-4aa0-bf37-0ce70bc7900&title=&width=777" alt="image.png"><br><strong>假设id字段添加了索引，并且采用了B Trees数据结构，查找id&#x3D;10的数据，只需要3次磁盘IO。</strong><br>4阶的B Trees：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692341965676-a9d34529-7b4d-45e3-baf3-4714a65bd0e4.png#averageHue=%23dab647&clientId=ua5acc0fc-19f8-4&from=paste&height=365&id=u0b3b3d12&originHeight=365&originWidth=714&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21314&status=done&style=shadow&taskId=ue7257cf7-b625-45e1-8c39-b375bcb124d&title=&width=714" alt="image.png"></p>
<p>更加详细的存储是这样的，请看下图：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692346278862-ee20dcee-9b4e-4678-a777-9e782601958a.png#averageHue=%23f2f1ed&clientId=ua5acc0fc-19f8-4&from=paste&height=401&id=u93e4ec03&originHeight=401&originWidth=339&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3456&status=done&style=shadow&taskId=ude17afd1-355c-4635-a3c5-bad9b042a86&title=&width=339" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692344122602-a45b07fe-c85a-42c2-9a20-008b2ad5002c.png#averageHue=%23060604&clientId=ua5acc0fc-19f8-4&from=paste&height=574&id=u72a034da&originHeight=574&originWidth=976&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47609&status=done&style=shadow&taskId=udfbf426f-5485-495e-ab7e-f84b3af809f&title=&width=976" alt="未命名文件.png"><br>在B Trees中，每个节点不仅存储了<code>索引值</code>，还存储该索引值对应的<code>数据行</code>。<br>并且每个节点中的p1 p2 p3是指向下一个节点的指针。</p>
<p>B Trees数据结构存在的缺点是：不适合做区间查找，对于区间查找效率较低。假设要查id在[3~7]之间的，需要查找的是3,4,5,6,7。那么查这每个索引值都需要从头节点开始。<br>因此MySQL使用了B+ Trees解决了这个问题。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=FqRiA&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="B-Trees（B-树）"><a href="#B-Trees（B-树）" class="headerlink" title="B+ Trees（B+ 树）"></a>B+ Trees（B+ 树）</h3><p>B+ Trees 相较于 B Trees改进了哪些？</p>
<ul>
<li>B+树将数据都存储在叶子节点中。并且叶子节点之间使用链表连接，这样很适合范围查询。</li>
<li>B+树的非叶子节点上只有索引值，没有数据，所以非叶子节点可以存储更多的索引值，这样让B+树更矮更胖，提高检索效率。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692347138609-6544b852-3198-4920-ab3c-95a41e80802a.png#averageHue=%23dbb746&clientId=ua5acc0fc-19f8-4&from=paste&height=387&id=u8399423e&originHeight=387&originWidth=715&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20505&status=done&style=shadow&taskId=u68bcb07a-b13f-43e9-b4ca-299d948207d&title=&width=715" alt="image.png"></p>
<p>假设有这样一张表：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692346967611-4a60f469-aa1d-4244-90e3-129d7ea36fb4.png#averageHue=%23f2f1ec&clientId=ua5acc0fc-19f8-4&from=paste&height=321&id=u3498f1b7&originHeight=321&originWidth=339&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2712&status=done&style=shadow&taskId=u7a6b4b7c-8f23-4baf-a93b-1c7b0c922d4&title=&width=339" alt="image.png"><br>B+ Trees方式存储的话如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692349477753-ce686f45-052c-4935-9212-5edf0f73149f.png#averageHue=%23060604&clientId=ua5acc0fc-19f8-4&from=paste&height=605&id=u5c2e3e09&originHeight=605&originWidth=1189&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53656&status=done&style=shadow&taskId=ubbc8ad77-4829-41f1-b628-6d554d4e9ca&title=&width=1189" alt="未命名文件 (1).png"></p>
<p><strong>经典面试题：</strong>mysql为什么选择B+树作为索引的数据结构，而不是B树？</p>
<ol>
<li>非叶子节点上可以存储更多的键值，阶数可以更大，更矮更胖，磁盘IO次数少，数据查询效率高。</li>
<li>所有数据都是有序存储在叶子节点上，让范围查找，分组查找效率更高。</li>
<li>数据页之间、数据记录之间采用链表链接，让升序降序更加方便操作。</li>
</ol>
<p><strong>经典面试题：</strong>如果一张表没有主键索引，那还会创建B+树吗？<br>当一张表没有主键索引时，默认会使用一个隐藏的内置的聚集索引（clustered index）。这个聚集索引是基于表的物理存储顺序构建的，通常是使用B+树来实现的。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=rRVJS&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="其他索引及相关调优"><a href="#其他索引及相关调优" class="headerlink" title="其他索引及相关调优"></a>其他索引及相关调优</h2><h3 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a>Hash索引</h3><p>支持Hash索引的存储引擎有：</p>
<ul>
<li>InnoDB（不支持手动创建Hash索引，系统会自动维护一个<code>自适应的Hash索引</code>）<ul>
<li>对于InnoDB来说，即使手动指定了某字段采用Hash索引，最终<code>show index from 表名</code>的时候，还是<code>BTREE</code>。</li>
</ul>
</li>
<li>Memory（支持Hash索引）</li>
</ul>
<p>Hash索引底层的数据结构就是哈希表。一个数组，数组中每个元素是链表。和java中HashMap一样。哈希表中每个元素都是key value结构。key存储<code>索引值</code>，value存储<code>行指针</code>。</p>
<p>原理如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692401422670-6fb725df-8901-480c-9838-021bd25cc726.png#averageHue=%23dfe5ea&clientId=u333d438f-7a08-4&from=paste&height=163&id=u6c1061c9&originHeight=163&originWidth=343&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2027&status=done&style=shadow&taskId=uffe4a02c-c002-4dea-84e4-4db3b72d4df&title=&width=343" alt="image.png"><br>如果name字段上添加了Hash索引idx_name</p>
<p>Hash索引长这个样子：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692401394351-b98f716f-7f04-4e57-823b-68fefc98b8d2.png#averageHue=%23f6f5f5&clientId=u333d438f-7a08-4&from=paste&height=425&id=u4a59ca3c&originHeight=425&originWidth=855&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14698&status=done&style=shadow&taskId=uf7b3196f-9d55-44e8-8dc7-2cdea15acd8&title=&width=855" alt="无标题.png"></p>
<p>检索原理：假设 name&#x3D;’孙行者’。通过哈希算法将’孙行者’转换为数组下标，通过下标找链表，在链表上遍历找到孙行者的行指针。</p>
<p>注意：不同的字符串，经过哈希算法得到的数组下标可能相同，这叫做哈希碰撞&#x2F;哈希冲突。【不过，好的哈希算法应该具有很低的碰撞概率。常用的哈希算法如MD5、SHA-1、SHA-256等都被设计为尽可能减少碰撞的发生。】</p>
<p>Hash索引优缺点：</p>
<ul>
<li>优点：只能用在等值比较中，效率很高。例如：name&#x3D;’孙悟空’</li>
<li>缺点：不支持排序，不支持范围查找。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=o4FjP&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="聚集索引和非聚集索引"><a href="#聚集索引和非聚集索引" class="headerlink" title="聚集索引和非聚集索引"></a>聚集索引和非聚集索引</h3><p>按照数据的物理存储方式不同，可以将索引分为聚集索引（聚簇索引）和非聚集索引（非聚簇索引）。</p>
<p>存储引擎是InnoDB的，主键上的索引属于聚集索引。<br>存储引擎是MyISAM的，任意字段上的索引都是非聚集索引。</p>
<p>InnoDB的物理存储方式：当创建一张表t_user，并使用InnoDB存储引擎时，会在硬盘上生成这样一个文件：</p>
<ul>
<li>t_user.ibd （InnoDB data表索引 + 数据）</li>
<li>t_user.frm （存储表结构信息）</li>
</ul>
<p>MyISAM的物理存储方式：当创建一张表t_user，并使用MyISAM存储引擎时，会在硬盘上生成这样一个文件：</p>
<ul>
<li>t_user.MYD （表数据）</li>
<li>t_user.MYI （表索引）</li>
<li>t_user.frm （表结构）</li>
</ul>
<p><strong>注意：从MySQL8.0开始，不再生成frm文件了，引入了数据字典，用数据字典来统一存储表结构信息，例如：</strong></p>
<ul>
<li><strong>information_schema.TABLES （表包含了数据库中所有表的信息，例如表名、数据库名、引擎类型等）</strong></li>
<li><strong>information_schema.COLUMNS（表包含了数据库中所有表的列信息，例如列名、数据类型、默认值等）</strong></li>
</ul>
<p>聚集索引的原理图：（B+树，叶子节点上存储了索引值 + 数据）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692349477753-ce686f45-052c-4935-9212-5edf0f73149f.png#averageHue=%23060604&clientId=ua5acc0fc-19f8-4&from=paste&height=605&id=JUQl2&originHeight=605&originWidth=1189&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53656&status=done&style=shadow&taskId=ubbc8ad77-4829-41f1-b628-6d554d4e9ca&title=&width=1189" alt="未命名文件 (1).png"></p>
<p>非聚集索引的原理图：（B+树，叶子节点上存储了索引值 + 行指针）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692414826853-a7b1c060-26c2-43c0-ba55-6ac983e67fdb.png#averageHue=%23fafafa&clientId=u333d438f-7a08-4&from=paste&height=1046&id=udf365233&originHeight=1046&originWidth=1918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=52927&status=done&style=shadow&taskId=u5823f2f1-08db-4fc0-be56-fd8859e9d33&title=&width=1918" alt="未命名文件 (1).png"></p>
<p>聚集索引的优点和缺点：</p>
<ol>
<li>优点：聚集索引将数据存储在索引树的叶子节点上。可以减少一次查询，因为查询索引树的同时可以获取数据。</li>
<li>缺点：对数据进行修改或删除时需要更新索引树，会增加系统的开销。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=aD8lt&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="二级索引"><a href="#二级索引" class="headerlink" title="二级索引"></a>二级索引</h3><p>二级索引也属于非聚集索引。也有人把二级索引称为辅助索引。<br>有表t_user，id是主键。age是非主键。在age字段上添加的索引称为二级索引。（所有非主键索引都是二级索引）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692416482381-7ff192ad-a4ce-4292-b5c6-045f57768b72.png#averageHue=%23eaeaea&clientId=u333d438f-7a08-4&from=paste&height=209&id=uef214edb&originHeight=209&originWidth=343&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2566&status=done&style=shadow&taskId=u43c578a0-3cf4-40fd-966c-61be3441db0&title=&width=343" alt="image.png"></p>
<p>二级索引的数据结构：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692417008406-ebae09f8-dea7-4b6a-ab56-100e31611421.png#averageHue=%23fbfafa&clientId=u333d438f-7a08-4&from=paste&height=289&id=u7b39f705&originHeight=289&originWidth=582&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12930&status=done&style=shadow&taskId=ub45e4a96-b6ea-44da-ad92-0e85bd0d663&title=&width=582" alt="无标题.png"></p>
<p>二级索引的查询原理：<br>假设查询语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user <span class="keyword">where</span> age <span class="operator">=</span> <span class="number">30</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/21376908/1692417425624-818e9980-dbe6-4470-a4b2-9c91b33ca2b6.png#averageHue=%23fcfcfc&clientId=u333d438f-7a08-4&from=paste&height=312&id=ud7db5feb&originHeight=312&originWidth=1045&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20570&status=done&style=shadow&taskId=ud87cd638-0631-45e1-8db2-692fa8231ae&title=&width=1045" alt="无标题.png"></p>
<p>为什么会“回表”？因为使用了<code>select *</code><br>避免“回表【回到原数据表】”是提高SQL执行效率的手段。例如：select id from t_user where age &#x3D; 30; 这样的SQL语句是不需要回表的。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=DxRj4&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>覆盖索引（Covering Index），顾名思义，是指某个查询语句可以通过索引的覆盖来完成，而不需要回表查询真实数据。其中的覆盖指的是在执行查询语句时，查询需要的所有列都可以从索引中提取到，而不需要再去查询实际数据行获取查询所需数据。<br>当使用覆盖索引时，MySQL可以直接通过索引，也就是索引上的数据来获取所需的结果，而不必再去查找表中的数据。这样可以显著提高查询性能。</p>
<p>假设有一个用户表（user）包含以下列：id, username, email, age。</p>
<p>常见的查询是根据用户名查询用户的邮箱。如果为了提高这个查询的性能，可以创建一个覆盖索引，包含（username, email）这两列。</p>
<p>创建覆盖索引的SQL语句可以如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_username_email <span class="keyword">ON</span> <span class="keyword">user</span> (username, email);</span><br></pre></td></tr></table></figure>

<p>当执行以下查询时：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> email <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;lucy&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>MySQL可以直接使用覆盖索引（idx_user_username_email）来获取查询结果，而不必再去查找用户表中的数据。这样可以减少磁盘I&#x2F;O并提高查询效率。而如果没有覆盖索引，MySQL会先使用索引（username）来找到匹配的行，然后再回表查询获取邮箱，这个过程会增加更多的磁盘I&#x2F;O和查询时间。</p>
<p>值得注意的是，覆盖索引的创建需要考虑查询的字段选择。如果查询需要的字段较多，可能需要创建包含更多列的覆盖索引，以满足完全覆盖查询的需要。</p>
<p>覆盖索引具有以下优点：</p>
<ol>
<li>提高查询性能：覆盖索引能够满足查询的所有需求，同时不需要访问表中的实际数据行，从而可以提高查询性能。这是因为DBMS可以直接使用索引来执行查询，而不需要从磁盘读取实际的数据行。 </li>
<li>减少磁盘和内存访问次数：当使用覆盖索引时，DBMS不需要访问实际的数据行。这样可以减少磁盘和内存访问次数，从而提高查询性能。 </li>
<li>减少网络传输：由于在覆盖索引中可以存储所有查询所需的列，因此可以减少数据的网络传输次数，从而提高查询的性能。 </li>
<li>可以降低系统开销：在高压力的数据库系统中，使用覆盖索引可以减少系统开销，从而提高系统的可靠性和可维护性。</li>
</ol>
<p>覆盖索引的缺点包括：</p>
<ol>
<li>需要更多的内存：覆盖索引需要存储查询所需的所有列，因此需要更多的内存来存储索引。在大型数据库系统中，这可能会成为一项挑战。 </li>
<li>会使索引变得庞大：当索引中包含了许多列时，它们可能会使索引变得非常庞大，从而影响查询性能，并且可能会占用大量的磁盘空间。 </li>
<li>只有在查询中包含了索引列时才能使用：只有当查询中包含了所有的索引列时才能使用覆盖索引。如果查询中包含了其他列，DBMS仍然需要访问实际的数据行，并且无法使用覆盖索引提高查询性能。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=soH4o&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h3><p>索引下推（Index Condition Pushdown）是一种 MySQL 中的优化方法，它可以将查询中的过滤条件下推到索引层级中处理，从而减少回表次数，优化查询性能。</p>
<p>具体来说，在使用索引下推时，MySQL 会在索引的叶节点层级执行查询的过滤条件，过滤掉无用的索引记录，仅返回符合条件的记录的主键，这样就可以避免查询时回表读取表格的数据行，从而缩短了整个查询过程的时间。</p>
<p>假设有以下表结构：</p>
<p>表名：users</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
<th>city</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>John</td>
<td>25</td>
<td>New York</td>
</tr>
<tr>
<td>2</td>
<td>Alice</td>
<td>30</td>
<td>London</td>
</tr>
<tr>
<td>3</td>
<td>Bob</td>
<td>40</td>
<td>Paris</td>
</tr>
<tr>
<td>4</td>
<td>Olivia</td>
<td>35</td>
<td>Berlin</td>
</tr>
<tr>
<td>5</td>
<td>Michael</td>
<td>28</td>
<td>Sydney</td>
</tr>
</tbody></table>
<p>现在我们创建了一个多列索引：（索引下推通常是基于多列索引的。）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE users ADD INDEX idx_name_city_age (name, city, age);</span><br></pre></td></tr></table></figure>

<p>假设我们要查询年龄大于30岁，并且所在城市是”London”的用户，假设只给age字段添加了索引，它就不会使用索引下推。传统的查询优化器会将所有满足年龄大于30岁的记录读入内存，然后再根据城市进行筛选。</p>
<p>使用索引下推优化后，在索引范围扫描的过程中，优化器会判断只有在城市列为”London”的情况下，才会将满足年龄大于30岁的记录加载到内存中。这样就可以避免不必要的IO和数据传输，提高查询性能。</p>
<p>具体的查询语句可以是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE age &gt; 30 AND city = &#x27;London&#x27;;</span><br></pre></td></tr></table></figure>

<p>在执行这个查询时，优化器会使用索引下推技术，先根据索引范围扫描找到所有满足条件的记录，然后再回到原数据表中获取完整的行数据，最终返回结果。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=ORNnL&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="单列索引（单一索引）"><a href="#单列索引（单一索引）" class="headerlink" title="单列索引（单一索引）"></a>单列索引（单一索引）</h3><p>单列索引是指对数据库表中的某一列或属性进行索引创建，对该列进行快速查找和排序操作。单列索引可以加快查询速度，提高数据库的性能。</p>
<p>举个例子，假设我们有一个学生表（student），其中有以下几个列：学生编号（student_id）、姓名（name）、年龄（age）和性别（gender）。</p>
<p>如果我们针对学生表的学生编号（student_id）列创建了单列索引，那么可以快速地根据学生编号进行查询或排序操作。例如，我们可以使用以下SQL语句查询学生编号为123456的学生信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123456</span>;</span><br></pre></td></tr></table></figure>

<p>由于我们对学生编号列建立了单列索引，所以数据库可以直接通过索引快速定位到具有学生编号123456的那一行记录，从而加快查询速度。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=MDT5X&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="复合索引（组合索引）"><a href="#复合索引（组合索引）" class="headerlink" title="复合索引（组合索引）"></a>复合索引（组合索引）</h3><p>复合索引（Compound Index）也称为多列索引（Multi-Column Index），是指对数据库表中多个列进行索引创建。</p>
<p>与单列索引不同，复合索引可以包含多个列。这样可以将多个列的值组合起来作为索引的键，以提高多列条件查询的效率。</p>
<p>举个例子，假设我们有一个订单表（Order），其中包含以下几个列：订单编号（OrderID）、客户编号（CustomerID）、订单日期（OrderDate）和订单金额（OrderAmount）。</p>
<p>如果我们为订单表的客户编号和订单日期这两列创建复合索引（CustomerID, OrderDate），那么可以在查询时同时根据客户编号和订单日期来快速定位到匹配的记录。</p>
<p>例如，我们可以使用以下SQL语句查询客户编号为123456且订单日期为2021-01-01的订单信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">Order</span> <span class="keyword">WHERE</span> CustomerID <span class="operator">=</span> <span class="number">123456</span> <span class="keyword">AND</span> OrderDate <span class="operator">=</span> <span class="string">&#x27;2021-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>由于我们为客户编号和订单日期创建了复合索引，数据库可以使用这个索引来快速定位到符合条件的记录，从而加快查询速度。复合索引的使用能够提高多列条件查询的效率，但需要注意的是，复合索引的创建和维护可能会增加索引的存储空间和对于写操作的影响。</p>
<p><strong>相对于单列索引，复合索引有以下几个优势：</strong></p>
<ol>
<li>减少索引的数量：复合索引可以包含多个列，因此可以减少索引的数量，减少索引的存储空间和维护成本。</li>
<li>提高查询性能：当查询条件中涉及到复合索引的多个列时，数据库可以使用复合索引进行快速定位和过滤，从而提高查询性能。</li>
<li>覆盖查询：如果复合索引包含了所有查询需要的列，那么数据库可以直接使用索引中的数据，而不需要再进行表的读取，从而提高查询性能。</li>
<li>排序和分组：由于复合索引包含多个列，因此可以用于排序和分组操作，从而提高排序和分组的性能。</li>
</ol>
<h2 id="索引的优缺点"><a href="#索引的优缺点" class="headerlink" title="索引的优缺点"></a>索引的优缺点</h2><p>索引是数据库中一种重要的数据结构，用于加速数据的检索和查询操作。它的优点和缺点如下：</p>
<p>优点：</p>
<ol>
<li>提高查询性能：通过创建索引，可以大大减少数据库查询的数据量，从而提升查询的速度。</li>
<li>加速排序：当查询需要按照某个字段进行排序时，索引可以加速排序的过程，提高排序的效率。</li>
<li>减少磁盘IO：索引可以减少磁盘IO的次数，这对于磁盘读写速度较低的场景，尤其重要。</li>
</ol>
<p>缺点：</p>
<ol>
<li>占据额外的存储空间：索引需要占据额外的存储空间，特别是在大型数据库系统中，索引可能占据较大的空间。</li>
<li>增删改操作的性能损耗：每次对数据表进行插入、更新、删除等操作时，需要更新索引，会导致操作的性能降低。</li>
<li>资源消耗较大：索引需要占用内存和CPU资源，特别是在大规模并发访问的情况下，可能对系统的性能产生影响。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=DzfcG&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="何时用索引"><a href="#何时用索引" class="headerlink" title="何时用索引"></a>何时用索引</h2><p>在以下情况下建议使用索引：</p>
<ol>
<li>频繁执行查询操作的字段：如果这些字段经常被查询，使用索引可以提高查询的性能，减少查询的时间。 </li>
<li>大表：当表的数据量较大时，使用索引可以快速定位到所需的数据，提高查询效率。 </li>
<li>需要排序或者分组的字段：在对字段进行排序或者分组操作时，索引可以减少排序或者分组的时间。 </li>
<li>外键关联的字段：在进行表之间的关联查询时，使用索引可以加快关联查询的速度。</li>
</ol>
<p>在以下情况下不建议使用索引：</p>
<ol>
<li>频繁执行更新操作的表：如果表经常被更新数据，使用索引可能会降低更新操作的性能，因为每次更新都需要维护索引。 </li>
<li>小表：对于数据量较小的表，使用索引可能并不会带来明显的性能提升，反而会占用额外的存储空间。 </li>
<li>对于唯一性很差的字段，一般不建议添加索引。当一个字段的唯一性很差时，查询操作基本上需要扫描整个表的大部分数据。如果为这样的字段创建索引，索引的大小可能会比数据本身还大，导致索引的存储空间占用过高，同时也会导致查询操作的性能下降。</li>
</ol>
<p>总之，索引需要根据具体情况进行使用和权衡，需要考虑到表的大小、查询频率、更新频率以及业务需求等因素。</p>
<h1 id="MySQL优化"><a href="#MySQL优化" class="headerlink" title="MySQL优化"></a>MySQL优化</h1><h2 id="MySQL优化手段"><a href="#MySQL优化手段" class="headerlink" title="MySQL优化手段"></a>MySQL优化手段</h2><p>MySQL数据库的优化手段通常包括但不限于：</p>
<ul>
<li>SQL查询优化：这是最低成本的优化手段，通过优化查询语句、适当添加索引等方式进行。并且效果显著。</li>
<li>库表结构优化：通过规范化设计、优化索引和数据类型等方式进行库表结构优化，需要对数据库结构进行调整和改进</li>
<li>系统配置优化：根据硬件和操作系统的特点，调整最大连接数、内存管理、IO调度等参数</li>
<li>硬件优化：升级硬盘、增加内存容量、升级处理器等硬件方面的投入，需要购买和替换硬件设备，成本较高</li>
</ul>
<p>我们主要掌握：SQL查询优化</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=DzfcG&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="SQL性能分析工具"><a href="#SQL性能分析工具" class="headerlink" title="SQL性能分析工具"></a>SQL性能分析工具</h2><h3 id="查看数据库整体情况"><a href="#查看数据库整体情况" class="headerlink" title="查看数据库整体情况"></a>查看数据库整体情况</h3><p>通过以下命令可以查看当前数据库在SQL语句执行方面的整体情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_select&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_insert&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_delete&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_update&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Com_______&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这些结果反映了从 MySQL 服务器启动到当前时刻，所有的 SELECT 查询总数。对于 MySQL 性能优化来说，通过查看 <code>Com_select</code> 的值可以了解 SELECT 查询在整个 MySQL 服务期间所占比例的情况：</p>
<ul>
<li>如果 <code>Com_select</code> 次数过高，可能说明查询表中的每条记录都会返回过多的字段。</li>
<li>如果 <code>Com_select</code> 次数很少，同时insert或delete或update的次数很高，可能说明服务器运行的应用程序过于依赖写入操作和少量读取操作。</li>
</ul>
<p>总之，通过查看 <code>Com_select</code> 的值，可以了解 MySQL 服务器的长期执行情况，并在优化查询性能时，帮助我们了解 MySQL 的性能瓶颈。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=DMMzD&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>慢查询日志文件可以将查询较慢的DQL语句记录下来，便于我们定位需要调优的select语句。<br>通过以下命令查看慢查询日志功能是否开启：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709606608296-a4ccd38c-c353-4a5e-bd8c-9d51d15374ff.png#averageHue=%23161412&clientId=u1bbf35a1-ca62-4&from=paste&height=112&id=u210c5b81&originHeight=112&originWidth=315&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4586&status=done&style=none&taskId=u261aee54-a8a7-468c-ad22-c9059861cb2&title=&width=315" alt="image.png"><br>慢查询日志功能默认是关闭的。请修改my.ini文件来开启慢查询日志功能，在my.ini的[mysqld]后面添加如下配置：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709606812974-8aff10a9-5595-41aa-a64b-ea1d1b666999.png#averageHue=%23fdfaf8&clientId=u1bbf35a1-ca62-4&from=paste&height=285&id=ueaebdf7e&originHeight=285&originWidth=350&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10518&status=done&style=none&taskId=uceb1546e-7784-4eea-8d71-9443c9b3149&title=&width=350" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709606969144-3bf8c279-f05b-4788-98b5-0c891bb40585.png#averageHue=%23f3f1ef&clientId=u1bbf35a1-ca62-4&from=paste&height=127&id=ua72cf8e3&originHeight=127&originWidth=316&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6526&status=done&style=none&taskId=u3d056f4c-25b1-4e32-9a5d-644198b3a6b&title=&width=316" alt="image.png"><br>注意：slow_query_log&#x3D;1表示开启慢查询日志功能，long_query_time&#x3D;3表示：只要SELECT语句的执行耗时超过3秒则将其记录到慢查询日志中。<br>重启mysql服务。再次查看是否开启慢查询日志功能：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709606848489-73c9ee06-7264-4e69-9f82-557973eec793.png#averageHue=%23141210&clientId=u1bbf35a1-ca62-4&from=paste&height=211&id=ub5e18942&originHeight=211&originWidth=480&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21908&status=done&style=none&taskId=udef397a2-544d-4195-bc54-4c868c41303&title=&width=480" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709606863859-18c78fe1-1e63-4f41-b4c1-cab73d311927.png#averageHue=%2313110f&clientId=u1bbf35a1-ca62-4&from=paste&height=183&id=u51e64fd1&originHeight=183&originWidth=549&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11421&status=done&style=none&taskId=u6fd5f422-e867-4432-beaf-60017743f43&title=&width=549" alt="image.png"></p>
<p>尝试执行一条时长超过3秒的select语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,ename,sleep(<span class="number">4</span>) <span class="keyword">from</span> emp <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;smith&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>慢查询日志文件默认存储在：C:\dev\mysql-8.0.36-winx64\data 目录下，默认的名字是：计算机名-slow.log<br>通过该文件可以清晰的看到哪些DQL语句属于慢查询：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709607677892-55420a92-0c66-4dff-a34e-85ba3ef1fa77.png#averageHue=%23f6f2f0&clientId=u1bbf35a1-ca62-4&from=paste&height=360&id=u5357d1d9&originHeight=360&originWidth=1264&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40700&status=done&style=shadow&taskId=u96de1bce-7f1e-4608-8eec-88635aa660f&title=&width=1264" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=SzisA&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="show-profiles"><a href="#show-profiles" class="headerlink" title="show profiles"></a>show profiles</h3><p>通过show profiles可以查看一个SQL语句在执行过程中具体的耗时情况。帮助我们更好的定位问题所在。</p>
<p>查看当前数据库是否支持 profile操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@have_profiling</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608207454-21a4e8a0-aaed-4c7e-a145-8e006efc79b5.png#averageHue=%23121110&clientId=u1bbf35a1-ca62-4&from=paste&height=138&id=uc91f2727&originHeight=138&originWidth=413&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7034&status=done&style=shadow&taskId=uecb73d27-9d3d-4149-897b-58179fb9dbf&title=&width=413" alt="image.png"></p>
<p>查看 profiling 开关是否打开：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608223016-c81a692f-11f4-4cf9-89ab-73d7ccb17327.png#averageHue=%23121110&clientId=u1bbf35a1-ca62-4&from=paste&height=138&id=ud07b7db5&originHeight=138&originWidth=365&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5765&status=done&style=shadow&taskId=u7841096e-d19e-400d-acc1-2ea0eb71b11&title=&width=365" alt="image.png"></p>
<p>将 profiling 开关打开：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608246449-a1a5b6a5-64ae-453c-8e75-c14734c08a2e.png#averageHue=%23100f0e&clientId=u1bbf35a1-ca62-4&from=paste&height=250&id=u948237d1&originHeight=250&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15181&status=done&style=shadow&taskId=ue2e11072-5cad-41f6-87f8-6b4ebb4fb3f&title=&width=576" alt="image.png"></p>
<p>可以执行多条DQL语句，然后使用 show profiles; 来查看当前数据库中执行过的每个SELECT语句的耗时情况。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">select</span> empno,ename <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">7369</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">show</span> profiles;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608477900-aef25ddf-a9ea-4caa-982c-633a75adc684.png#averageHue=%23141211&clientId=u1bbf35a1-ca62-4&from=paste&height=185&id=ue1ad13db&originHeight=185&originWidth=870&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17479&status=done&style=shadow&taskId=u5b746d60-cce8-4d00-86fd-a87e1e326b3&title=&width=870" alt="image.png"></p>
<p>查看某个SQL语句语句在执行过程中，每个阶段的耗时情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608620665-462b1fae-d1bb-49cb-9fc0-a4ee4e74e8a9.png#averageHue=%23141210&clientId=u1bbf35a1-ca62-4&from=paste&height=490&id=ue2e1a07e&originHeight=490&originWidth=546&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38244&status=done&style=shadow&taskId=u679c4a6c-fe2d-415a-8c1d-61331ac89de&title=&width=546" alt="image.png"></p>
<p>想查看执行过程中cpu的情况，可以执行以下命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profile cpu <span class="keyword">for</span> query <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709608704507-1e11a01d-cf8d-4208-9d1e-1a55287e8c0d.png#averageHue=%23161311&clientId=u1bbf35a1-ca62-4&from=paste&height=490&id=u28beb940&originHeight=490&originWidth=831&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44398&status=done&style=shadow&taskId=u99024dea-0f7d-4b4f-8d21-1e097d5070e&title=&width=831" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=aAuU2&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h3><p>explain命令可以查看一个DQL语句的执行计划，根据执行计划可以做出相应的优化措施。提高执行效率。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno<span class="operator">=</span><span class="number">7369</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709802585549-f377b6db-7fff-4b76-8c8f-8770df3f6b7f.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=76&id=u83c0f5ad&originHeight=76&originWidth=1414&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5085&status=done&style=shadow&taskId=ueb9576b2-b431-461d-9fe8-1ccd9ecfe0e&title=&width=1414" alt="image.png"></p>
<h4 id="id"><a href="#id" class="headerlink" title="id"></a>id</h4><p>id反映出一条select语句执行顺序，id越大优先级越高。id相同则按照自上而下的顺序执行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> e.ename,d.dname <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno<span class="operator">=</span>d.deptno <span class="keyword">join</span> salgrade s <span class="keyword">on</span> e.sal <span class="keyword">between</span> s.losal <span class="keyword">and</span> s.hisal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709802962333-8700f0d2-9db0-4ccb-b35a-20dcb0189ca4.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=102&id=ubd183a12&originHeight=102&originWidth=1419&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10534&status=done&style=shadow&taskId=u5c7862c4-b39c-4a1c-8fd3-4a0b01c87c7&title=&width=1419" alt="image.png"><br>由于id相同，反映出三张表在执行顺序上属于平等关系，执行时采用，先d，再e，最后s。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> e.ename,d.dname <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno<span class="operator">=</span>d.deptno <span class="keyword">where</span> e.sal<span class="operator">=</span>(<span class="keyword">select</span> sal <span class="keyword">from</span> emp <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;ford&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709803180821-4cb09e82-1c77-4ecd-b943-e087f9c736a0.png#averageHue=%23f3f3f2&clientId=u35b840e1-8af8-4&from=paste&height=111&id=u33484cc8&originHeight=111&originWidth=1425&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10128&status=done&style=shadow&taskId=u9a25fc3d-c6b9-4a11-af93-f842d73f328&title=&width=1425" alt="image.png"><br>反映出，先执行子查询，然后让e和d做表连接。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=Kf7bM&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="select-type"><a href="#select-type" class="headerlink" title="select_type"></a>select_type</h4><p>反映了mysql查询语句的类型。常用值包括：</p>
<ul>
<li>SIMPLE：表示查询中不包含子查询或UNION操作。这种查询通常包括一个表或是最多一个联接（JOIN）</li>
<li>PRIMARY：表示当前查询是一个主查询。（主要的查询）</li>
<li>UNION：表示查询中包含UNION操作</li>
<li>SUBQUERY：子查询</li>
<li>DERIVED：派生表（表示查询语句出现在from后面）</li>
</ul>
<h4 id="table"><a href="#table" class="headerlink" title="table"></a>table</h4><p>反映了这个查询操作的是哪个表。</p>
<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><p>反映了查询表中数据时的访问类型，常见的值：</p>
<ol>
<li>NULL：效率最高，一般不可能优化到这个级别，只有查询时没有查询表的时候，访问类型是NULL。例如：select 1;</li>
<li>system：通常访问系统表的时候，访问类型是system。一般也很难优化到这个程序。</li>
<li>const：根据主键或者唯一性索引查询，索引值是常量值时。explain select * from emp where empno&#x3D;7369;</li>
<li>eq_ref：根据主键或者唯一性索引查询。索引值不是常量值。</li>
<li>ref：使用了非唯一的索引进行查询。</li>
<li>range：使用了索引，扫描了索引树的一部分。</li>
<li>index：表示用了索引，但是也需要遍历整个索引树。</li>
<li>all：全表扫描</li>
</ol>
<p>效率最高的是NULL，效率最低的是all，从上到下，从高到低。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=pCG2v&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="possible-keys"><a href="#possible-keys" class="headerlink" title="possible_keys"></a>possible_keys</h4><p>这个查询可能会用到的索引</p>
<h4 id="key"><a href="#key" class="headerlink" title="key"></a>key</h4><p>实际用到的索引</p>
<h4 id="key-len"><a href="#key-len" class="headerlink" title="key_len"></a>key_len</h4><p>反映索引中在查询中使用的列所占的总字节数。</p>
<h4 id="rows"><a href="#rows" class="headerlink" title="rows"></a>rows</h4><p>查询扫描的预估计行数。</p>
<h4 id="Extra"><a href="#Extra" class="headerlink" title="Extra"></a>Extra</h4><p>给出了与查询相关的额外信息和说明。这些额外信息可以帮助我们更好地理解查询执行的过程。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=lWVj7&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><h3 id="加索引-vs-不加索引"><a href="#加索引-vs-不加索引" class="headerlink" title="加索引 vs 不加索引"></a>加索引 vs 不加索引</h3><p>将这个sql脚本初始化到数据库中（初始化100W条记录）：t_vip.sql<br>根据id查询（id是主键，有索引）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">900000</span>;</span><br></pre></td></tr></table></figure>

<p>根据name查询（name上没有索引）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;4c6494cb&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>给name字段添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_t_user_name <span class="keyword">on</span> t_vip(name);</span><br></pre></td></tr></table></figure>

<p>再次根据name查询（此时name上已经有索引了） ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_vip <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;4c6494cb&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=JtTIo&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h3><p>假设有这样一张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_customer(</span><br><span class="line">	id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">	age <span class="type">int</span>,</span><br><span class="line">	gender <span class="type">char</span>(<span class="number">1</span>),</span><br><span class="line">	email <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>添加了这些数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;zhangsan@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="number">22</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;lisi@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;wangwu&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;wangwu@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;zhaoliu&#x27;</span>, <span class="number">22</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;zhaoliu@123.com&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;jack&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;jack@123.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>添加了这样的复合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name_age_gender <span class="keyword">on</span> t_customer(name,age,gender);</span><br></pre></td></tr></table></figure>

<p><strong>最左前缀原则：当查询语句条件中包含了这个复合索引最左边的列 name 时，此时索引才会起作用。</strong></p>
<p>验证1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：完全使用了索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620707530-1bf42ae8-0a5a-48d4-a175-f63cd590cc27.png#averageHue=%23f0efee&clientId=u75f16c53-61e9-4&from=paste&height=77&id=u9b1a3cd4&originHeight=77&originWidth=1233&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6530&status=done&style=shadow&taskId=ue11ca645-e658-44d2-a33c-ad9d556733a&title=&width=1233" alt="image.png"></p>
<p>验证2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：使用了部分索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620741009-6e68b6e8-72f9-4dac-b81c-4a7a83e2fc3d.png#averageHue=%23efeded&clientId=u75f16c53-61e9-4&from=paste&height=69&id=ue40d9726&originHeight=69&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6262&status=done&style=shadow&taskId=ue029fc49-fb04-463d-b957-6fbe89123ca&title=&width=1226" alt="image.png"></p>
<p>验证3：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：使用了部分索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620763950-41d223ab-585f-413d-a57b-4974c6f0beab.png#averageHue=%23efeeed&clientId=u75f16c53-61e9-4&from=paste&height=72&id=u8bce969b&originHeight=72&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6335&status=done&style=shadow&taskId=ua9f2ed2a-6f4e-4363-8a9c-e49cffdb37c&title=&width=1226" alt="image.png"></p>
<p>验证4：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：完全使用了索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620790877-981fb10c-d890-45ba-a216-7657788fb107.png#averageHue=%23f3f2f1&clientId=u75f16c53-61e9-4&from=paste&height=98&id=u8406d237&originHeight=98&originWidth=1231&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7142&status=done&style=shadow&taskId=ud8c1fc7d-77b0-4764-9e68-b2bedac00c9&title=&width=1231" alt="image.png"></p>
<p>验证5：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：没有使用任何索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620812205-51aeb294-baeb-4170-9aec-9227568689e8.png#averageHue=%23f1f1f0&clientId=u75f16c53-61e9-4&from=paste&height=76&id=uaede0bcd&originHeight=76&originWidth=1224&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5254&status=done&style=shadow&taskId=ucfc9e344-95a0-4783-a44e-436766ba3e8&title=&width=1224" alt="image.png"></p>
<p>验证6：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：使用了部分索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709620943989-005425b6-42c5-4ed5-93ec-f60966f7a62a.png#averageHue=%23f2f0f0&clientId=u75f16c53-61e9-4&from=paste&height=87&id=u06dd06a9&originHeight=87&originWidth=1225&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6567&status=done&style=shadow&taskId=uf1143a9e-dd31-4173-ac3e-17d0dac7968&title=&width=1225" alt="image.png"></p>
<p>验证7：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：完全使用了索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709621197079-aea69012-aa33-43fd-ac04-4e836a41ac49.png#averageHue=%23f2f0f0&clientId=u75f16c53-61e9-4&from=paste&height=86&id=u5af42892&originHeight=86&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6520&status=done&style=shadow&taskId=u89b6599c-fef6-481c-b822-662c6eac2ee&title=&width=1226" alt="image.png"></p>
<p><strong>范围查询时，在“范围条件”右侧的列索引会失效：</strong><br>验证：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">&gt;</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：name和age列索引生效。gender列索引无效。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709621337919-fa59c6b8-6bdd-47f8-bb5d-1c944ca8d1f3.png#averageHue=%23f1efee&clientId=u75f16c53-61e9-4&from=paste&height=77&id=ufc1c332e&originHeight=77&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6427&status=done&style=shadow&taskId=u34989e10-0f7b-471c-aafd-1b2ed3e647f&title=&width=1226" alt="image.png"><br>怎么解决？建议范围查找时带上“&#x3D;”</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span> <span class="keyword">and</span> age<span class="operator">&gt;=</span><span class="number">20</span> <span class="keyword">and</span> gender<span class="operator">=</span><span class="string">&#x27;M&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709621423612-619d1ea5-3b98-4947-ab73-6f0ac42cfddf.png#averageHue=%23f1f0ef&clientId=u75f16c53-61e9-4&from=paste&height=82&id=u25f8a2d7&originHeight=82&originWidth=1229&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6657&status=done&style=shadow&taskId=u17028540-44fd-440f-9cd8-594c7a1d182&title=&width=1229" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=dW2dD&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="索引失效情况"><a href="#索引失效情况" class="headerlink" title="索引失效情况"></a>索引失效情况</h3><p>有这样一张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_emp(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  sal <span class="type">int</span>,</span><br><span class="line">  age <span class="type">char</span>(<span class="number">2</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>有这样一些数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">5000</span>,<span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;张飞&#x27;</span>, <span class="number">4000</span>,<span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_emp <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;李飞&#x27;</span>, <span class="number">6000</span>,<span class="string">&#x27;40&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>有这样一些索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_t_emp_name <span class="keyword">on</span> t_emp(name);</span><br><span class="line"><span class="keyword">create</span> index idx_t_emp_sal <span class="keyword">on</span> t_emp(sal);</span><br><span class="line"><span class="keyword">create</span> index idx_t_emp_age <span class="keyword">on</span> t_emp(age);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=M9hmJ&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="索引列参加了运算，索引失效"><a href="#索引列参加了运算，索引失效" class="headerlink" title="索引列参加了运算，索引失效"></a>索引列参加了运算，索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">5000</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：使用了索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709622626287-156e8f2e-9233-40ee-9740-fc13bac956b2.png#averageHue=%23f1f0f0&clientId=u75f16c53-61e9-4&from=paste&height=82&id=ue86c4189&originHeight=82&originWidth=1230&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5886&status=done&style=shadow&taskId=uda74fd1b-4c94-4936-8813-79cba63b06c&title=&width=1230" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> sal<span class="operator">*</span><span class="number">10</span> <span class="operator">&gt;</span> <span class="number">50000</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引失效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709622656653-0408c8c3-8c58-4856-a7f2-407a33255882.png#averageHue=%23f0efee&clientId=u75f16c53-61e9-4&from=paste&height=68&id=ua9cb8fa0&originHeight=68&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5004&status=done&style=shadow&taskId=u76feb04f-430d-4b0d-abca-bde56a34eaa&title=&width=1226" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=dCHZd&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="索引列进行模糊查询时以-开始的，索引失效"><a href="#索引列进行模糊查询时以-开始的，索引失效" class="headerlink" title="索引列进行模糊查询时以 % 开始的，索引失效"></a>索引列进行模糊查询时以 % 开始的，索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引有效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709622777843-e993f862-6523-48db-b5ec-fd6b8d6b81a8.png#averageHue=%23f2f0f0&clientId=u75f16c53-61e9-4&from=paste&height=82&id=uac080f8b&originHeight=82&originWidth=1227&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6041&status=done&style=shadow&taskId=uc660d0c7-51e9-43a4-bcbc-df0a5f55ed1&title=&width=1227" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%飞&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引失效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709622812719-bffd2a58-de91-413c-bbe9-afef66216412.png#averageHue=%23f2f1f1&clientId=u75f16c53-61e9-4&from=paste&height=83&id=u3307c19b&originHeight=83&originWidth=1232&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5167&status=done&style=shadow&taskId=u9dc0622b-972e-49d5-a0a1-85e40e0240e&title=&width=1232" alt="image.png"></p>
<h4 id="索引列是字符串类型，但查询时省略了单引号，索引失效"><a href="#索引列是字符串类型，但查询时省略了单引号，索引失效" class="headerlink" title="索引列是字符串类型，但查询时省略了单引号，索引失效"></a>索引列是字符串类型，但查询时省略了单引号，索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> age<span class="operator">=</span><span class="string">&#x27;20&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引有效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709623022492-47eb2402-b727-4c24-adc7-3985c2fbca3d.png#averageHue=%23f1f0f0&clientId=u75f16c53-61e9-4&from=paste&height=80&id=u2d1c59de&originHeight=80&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5271&status=done&style=shadow&taskId=u575e101b-560c-4351-aafd-cec3189afa9&title=&width=1226" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引失效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709623062895-ec669b01-a288-4403-b3a0-d6c0a6b50b77.png#averageHue=%23f2f2f1&clientId=u75f16c53-61e9-4&from=paste&height=82&id=uf90aa3b5&originHeight=82&originWidth=1231&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5368&status=done&style=shadow&taskId=u0e061030-0742-44e8-ac24-08c8ed27f98&title=&width=1231" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=gUFI1&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="查询条件中有or，只要有未添加索引的字段，索引失效"><a href="#查询条件中有or，只要有未添加索引的字段，索引失效" class="headerlink" title="查询条件中有or，只要有未添加索引的字段，索引失效"></a>查询条件中有or，只要有未添加索引的字段，索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">or</span> sal<span class="operator">=</span><span class="number">5000</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：使用了索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709623659977-13993818-9310-4e1c-a472-f0e56902ccc6.png#averageHue=%23f4f3f2&clientId=u75f16c53-61e9-4&from=paste&height=99&id=u27003f00&originHeight=99&originWidth=1362&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7084&status=done&style=shadow&taskId=ue6a2c5be-88a8-4a37-abfe-f8b11181877&title=&width=1362" alt="image.png"></p>
<p>将t_emp表sal字段上的索引删除：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_emp <span class="keyword">drop</span> index idx_t_emp_sal;</span><br></pre></td></tr></table></figure>

<p>再次验证：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_emp <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">or</span> sal<span class="operator">=</span><span class="number">5000</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：索引失效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709623713074-9e8ee071-84ce-44e9-89e4-d3a3f9534ddd.png#averageHue=%23f1f0ef&clientId=u75f16c53-61e9-4&from=paste&height=72&id=u7e588147&originHeight=72&originWidth=1345&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5460&status=done&style=shadow&taskId=u81c8b944-dc24-4197-9d97-d02f5be4450&title=&width=1345" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=QCR5Y&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="当查询的符合条件的记录在表中占比较大，索引失效"><a href="#当查询的符合条件的记录在表中占比较大，索引失效" class="headerlink" title="当查询的符合条件的记录在表中占比较大，索引失效"></a>当查询的符合条件的记录在表中占比较大，索引失效</h4><p>复制一张新表：emp2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp2 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<p>给sal添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp2 <span class="keyword">add</span> index idx_emp2_sal(sal);</span><br></pre></td></tr></table></figure>

<p>验证1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">800</span>;</span><br></pre></td></tr></table></figure>

<p>不走索引：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709624416152-f79a2fd0-f440-4848-9ebf-af30955177fa.png#averageHue=%23f1f0ef&clientId=u75f16c53-61e9-4&from=paste&height=71&id=ubaa14cc4&originHeight=71&originWidth=1352&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5596&status=done&style=shadow&taskId=u6c5eb6e8-7879-411d-ad7c-01118b70c77&title=&width=1352" alt="image.png"></p>
<p>验证2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<p>不走索引：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709624416152-f79a2fd0-f440-4848-9ebf-af30955177fa.png#averageHue=%23f1f0ef&clientId=u75f16c53-61e9-4&from=paste&height=71&id=hAdjc&originHeight=71&originWidth=1352&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5596&status=done&style=shadow&taskId=u6c5eb6e8-7879-411d-ad7c-01118b70c77&title=&width=1352" alt="image.png"></p>
<p>验证3：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> sal <span class="operator">&gt;</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure>

<p>走索引：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709624457745-c7680a75-84cb-4569-9b4e-07cdfdd08135.png#averageHue=%23f1f0ef&clientId=u75f16c53-61e9-4&from=paste&height=73&id=ubf126d85&originHeight=73&originWidth=1348&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5397&status=done&style=shadow&taskId=u8706c3c4-8968-4685-8b58-199b5c47842&title=&width=1348" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=OmaiC&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h4 id="关于is-null和is-not-null的索引失效问题"><a href="#关于is-null和is-not-null的索引失效问题" class="headerlink" title="关于is null和is not null的索引失效问题"></a>关于is null和is not null的索引失效问题</h4><p>给emp2的comm字段添加一个索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp2_comm <span class="keyword">on</span> emp2(comm);</span><br></pre></td></tr></table></figure>

<p>将emp2表的comm字段值全部更新为NULL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> emp2 <span class="keyword">set</span> comm<span class="operator">=</span><span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>验证此时条件使用is null是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：不走索引。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709694195151-1ca17464-4c88-45fa-b219-cb08f0b5091c.png#averageHue=%23f0efef&clientId=u832e6504-1b74-4&from=paste&height=68&id=u37bd1e0d&originHeight=68&originWidth=1351&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5412&status=done&style=shadow&taskId=u3c332f0e-d44b-47ce-8ae1-93ec5c5fd10&title=&width=1351" alt="image.png"><br>验证此时条件使用is not null是否走索引：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709694228684-a0adc3b3-2e1f-42a9-bc04-e9b3794f4c07.png#averageHue=%23eeedec&clientId=u832e6504-1b74-4&from=paste&height=61&id=u46c4c324&originHeight=61&originWidth=1348&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5257&status=done&style=shadow&taskId=ub8dbdb4b-ae22-42b7-9365-d62ded3075f&title=&width=1348" alt="image.png"></p>
<p>将emp2表的comm字段全部更新为非NULL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> emp2 <span class="keyword">set</span> comm<span class="operator">=</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>验证此时条件使用is null是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：走索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709694340514-f50fe8fb-362e-4ab4-b34d-0e2f914bafe2.png#averageHue=%23efeeed&clientId=u832e6504-1b74-4&from=paste&height=64&id=u5926030e&originHeight=64&originWidth=1354&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5293&status=done&style=shadow&taskId=ua3e13478-ec0b-4df6-bb04-0e53d9b65be&title=&width=1354" alt="image.png"><br>验证此时条件使用is not null是否走索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp2 <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>验证结果：不走索引<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709694398287-3000e893-0a5a-4284-a110-968a9f651b6e.png#averageHue=%23efeeee&clientId=u832e6504-1b74-4&from=paste&height=68&id=u4e6beae8&originHeight=68&originWidth=1354&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5632&status=done&style=shadow&taskId=u944ca771-d4e6-433a-abf2-7ea376745fd&title=&width=1354" alt="image.png"></p>
<p>结论：走索引还是不走索引，根数据分布有很大关系，如果符合条件的记录占比较大，会考虑使用全表扫描，而放弃走索引。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=EY6Mp&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="指定索引"><a href="#指定索引" class="headerlink" title="指定索引"></a>指定索引</h3><p>当一个字段上既有单列索引，又有复合索引时，我们可以通过以下的SQL提示来要求该SQL语句执行时采用哪个索引：</p>
<ul>
<li>use index(索引名称)：建议使用该索引，只是建议，底层mysql会根据实际效率来考虑是否使用你推荐的索引。</li>
<li>ignore index(索引名称)：忽略该索引</li>
<li>force index(索引名称)：强行使用该索引</li>
</ul>
<p>查看 t_customer 表上的索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> t_customer;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709695662786-e69e7393-fb4e-4ca9-a167-b81c6d1dcef4.png#averageHue=%23f9f8f6&clientId=u832e6504-1b74-4&from=paste&height=141&id=u8027b76a&originHeight=141&originWidth=950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11140&status=done&style=shadow&taskId=ufccb1506-f046-49af-86f8-ce60b1efc15&title=&width=950" alt="image.png"><br>可以看到name age gender三列添加了一个复合索引。<br>现在给name字段添加一个单列索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_name <span class="keyword">on</span> t_customer(name);</span><br></pre></td></tr></table></figure>

<p>看看以下的语句默认使用了哪个索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709695789495-7937dbd6-1c3b-4881-aeac-e868dd7e818d.png#averageHue=%23f5f4f3&clientId=u832e6504-1b74-4&from=paste&height=108&id=u0fe537ca&originHeight=108&originWidth=1350&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7064&status=done&style=shadow&taskId=u794e7ad2-d26f-4479-be56-b81c7464a7b&title=&width=1350" alt="image.png"><br>通过测试得知，默认使用了联合索引。</p>
<p>如何建议使用单列索引idx_name：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer use index(idx_name) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709695922746-7c298082-197e-49a9-be41-68a80eb1d8cd.png#averageHue=%23eeedec&clientId=u832e6504-1b74-4&from=paste&height=61&id=uacfb4dc3&originHeight=61&originWidth=1347&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5173&status=done&style=shadow&taskId=uc2f18419-fc69-4dab-9b1e-6fb98a1a3a9&title=&width=1347" alt="image.png"></p>
<p>如何忽略使用符合索引 idx_name_age_gender：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer ignore index(idx_name_age_gender) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709695945125-1fdb373d-e99d-40ff-ba0c-116f323de32a.png#averageHue=%23f1f0f0&clientId=u832e6504-1b74-4&from=paste&height=77&id=u2059b06f&originHeight=77&originWidth=1346&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5375&status=done&style=shadow&taskId=u66156ea8-68db-4846-82dd-0108c69e814&title=&width=1346" alt="image.png"></p>
<p>如何强行使用单列索引idx_name：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_customer force index(idx_name) <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709695965581-f97fc288-0420-4fd5-9fc6-b5a6d398389b.png#averageHue=%23f2f1f0&clientId=u832e6504-1b74-4&from=paste&height=79&id=u62a0d9e3&originHeight=79&originWidth=1338&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5357&status=done&style=shadow&taskId=ud0ebd6c4-faf9-4cd0-8008-99a6a1fccad&title=&width=1338" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=KjRzf&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="覆盖索引-1"><a href="#覆盖索引-1" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>覆盖索引我们在讲解索引的时候已经提到过了，覆盖索引强调的是：在select后面写字段的时候，这些字段尽可能是索引所覆盖的字段，这样可以避免回表查询。尽可能避免使用 select *，因为select * 很容易导致回表查询。（本质就是：能在索引上检索的，就不要再次回表查询了。）</p>
<p>例如：有一张表 emp3，其中 ename,job添加了联合索引：idx_emp3_ename_job，以下这个select语句就不会回表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> emp3;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp3 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp3 <span class="keyword">add</span> <span class="keyword">constraint</span> emp3_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"><span class="keyword">create</span> index idx_emp3_ename_job <span class="keyword">on</span> emp3(ename,job);</span><br><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp3 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709869967499-4087b2ec-38ec-423c-bc35-b6beea430958.png#averageHue=%23caa768&clientId=ucd943da5-f2f2-4&from=paste&height=83&id=u594bc3ee&originHeight=83&originWidth=1452&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6563&status=done&style=shadow&taskId=ue01a5a68-4bec-43a6-bf60-76b7c1ca78e&title=&width=1452" alt="image.png"><br>如果查询语句要查找的列没有在索引中，则会回表查询，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> empno,ename,job,sal <span class="keyword">from</span> emp3 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709870027544-6ff21f88-252e-4ea0-863c-7cbc60244423.png#averageHue=%23f3f1f0&clientId=ucd943da5-f2f2-4&from=paste&height=85&id=u1a058cfb&originHeight=85&originWidth=1495&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7712&status=done&style=shadow&taskId=u1216ccd4-32e7-4a53-8027-83ae45ea842&title=&width=1495" alt="image.png"><br>面试题：t_user表字段如下：id,name,password,realname,birth,email。表中数据量500万条，请针对以下SQL语句给出优化方案：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,realname <span class="keyword">from</span> t_user <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;鲁智深&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>如果只给name添加索引，底层会进行大量的回表查询，效率较低，建议给name和realname两个字段添加联合索引，这样大大减少回表操作，提高查询效率。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=BSFLj&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><p>如果一个字段类型是varchar或text字段，字段中存储的是文本或者大文本，直接对这种长文本创建索引，会让索引体积很大，怎么优化呢？可以将字符串的前几个字符截取下来当做索引来创建。这种索引被称为前缀索引，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> emp4;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp4 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">create</span> index idx_emp4_ename_2 <span class="keyword">on</span> emp4(ename(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>以上SQL表示将emp4表中ename字段的前2个字符创建到索引当中。</p>
<p>使用前缀索引时，需要通过以下公式来确定使用前几个字符作为索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,前几个字符)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>

<p>以上查询结果越接近1，表示索引的效果越好。（原理：做索引值的话，索引值越具有唯一性效率越高）</p>
<p>假设我们使用前1个字符作为索引值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,<span class="number">1</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709710923936-8ad47445-f0fc-4dd0-848d-d2035635bf42.png#averageHue=%23d3d1d0&clientId=u832e6504-1b74-4&from=paste&height=55&id=u30d177c0&originHeight=55&originWidth=176&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1645&status=done&style=shadow&taskId=uff63c5ed-375f-4cc0-a85b-01ea782449e&title=&width=176" alt="image.png"></p>
<p>假设我们使用前2个字符作为索引值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="built_in">substring</span>(ename,<span class="number">1</span>,<span class="number">2</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp4;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709710960232-d16e0bfd-3d49-45f5-b4cd-5bc2543ec6bf.png#averageHue=%23d0cecd&clientId=u832e6504-1b74-4&from=paste&height=50&id=ucad3b1a8&originHeight=50&originWidth=182&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1351&status=done&style=shadow&taskId=ueb32d080-9fcb-4f3f-8ad9-0b5d6e4f99d&title=&width=182" alt="image.png"><br>可见使用前2个字符作为索引值，能够让索引值更具有唯一性，效率越好，因此我们选择前2个字符作为前缀索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp4_ename_2 <span class="keyword">on</span> emp4(ename(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>执行以下的查询语句则会走这个前缀索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp4 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;KING&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709711252551-389620f6-0b3e-402f-8279-14714e0b6934.png#averageHue=%23f3f2f2&clientId=u832e6504-1b74-4&from=paste&height=85&id=u516d6059&originHeight=85&originWidth=1449&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5750&status=done&style=shadow&taskId=u29314072-63e8-412a-9e2f-5c304631fcd&title=&width=1449" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=d5p5u&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="单列索引和复合索引怎么选择"><a href="#单列索引和复合索引怎么选择" class="headerlink" title="单列索引和复合索引怎么选择"></a>单列索引和复合索引怎么选择</h3><p>当查询语句的条件中有多个条件，建议将这几个列创建为复合索引，因为创建单列索引很容易回表查询。<br>例如分别给emp5表ename，job添加两个单列索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp5 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp5 <span class="keyword">add</span> <span class="keyword">constraint</span> emp5_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_emp5_ename <span class="keyword">on</span> emp5(ename);</span><br><span class="line"><span class="keyword">create</span> index idx_emp5_job <span class="keyword">on</span> emp5(job);</span><br></pre></td></tr></table></figure>

<p>执行以下查询语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp5 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span> <span class="keyword">and</span> job<span class="operator">=</span><span class="string">&#x27;CLERK&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709712992383-465eef54-a764-4b4a-bb7b-d44b6eaf0755.png#averageHue=%23f6f3f3&clientId=u832e6504-1b74-4&from=paste&height=127&id=ub3a37eef&originHeight=127&originWidth=1489&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12323&status=done&style=shadow&taskId=ua0e9fb61-562f-4549-810e-40827bb1858&title=&width=1489" alt="image.png"></p>
<p>ename和job都出现在查询条件中，可以给emp6表的ename和job创建一个复合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp6 <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp6 <span class="keyword">add</span> <span class="keyword">constraint</span> emp6_pk <span class="keyword">primary</span> key(empno);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> index idx_emp6_ename_job <span class="keyword">on</span> emp6(ename,job);</span><br><span class="line">explain <span class="keyword">select</span> empno,ename,job <span class="keyword">from</span> emp6 <span class="keyword">where</span> ename<span class="operator">=</span><span class="string">&#x27;SMITH&#x27;</span> <span class="keyword">and</span> job<span class="operator">=</span><span class="string">&#x27;CLERK&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709713204610-5a0d695a-170d-447f-9ba0-a5b68719d539.png#averageHue=%23f3f2f2&clientId=u832e6504-1b74-4&from=paste&height=89&id=u38af9318&originHeight=89&originWidth=1473&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5990&status=done&style=shadow&taskId=uec0c7d7e-a85c-4e36-84f6-08136e4672d&title=&width=1473" alt="image.png"><br>对于以上查询语句，使用复合索引避免了回表，因此这种情况下还是建议使用复合索引。</p>
<p>注意：创建索引时应考虑最左前缀原则，主字段并且具有很强唯一性的字段建议排在第一位，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp_ename_job <span class="keyword">on</span> emp(ename,job);</span><br></pre></td></tr></table></figure>

<p>和以下方式对比：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_emp_job_ename <span class="keyword">on</span> emp(job,ename);</span><br></pre></td></tr></table></figure>

<p>由于ename是主字段，并且ename具有很好的唯一性，建议将ename列放在最左边。因此这两种创建复合索引的方式，建议采用第一种。</p>
<p>复合索引底层原理：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709715492890-3ee1db80-14c3-48c9-8e2c-dec200f039d9.png#averageHue=%23bcbbba&clientId=u832e6504-1b74-4&from=paste&height=446&id=u426aad54&originHeight=446&originWidth=1502&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51157&status=done&style=shadow&taskId=u646afbee-d394-4950-9ba3-c06f03041e0&title=&width=1502" alt="无标题.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=Ch4CY&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="索引创建原则"><a href="#索引创建原则" class="headerlink" title="索引创建原则"></a>索引创建原则</h3><ol>
<li>表数据量庞大，通常超过百万条数据。</li>
<li>经常出现在where，order by，group by后面的字段建议添加索引。</li>
<li>创建索引的字段尽量具有很强的唯一性。</li>
<li>如果字段存储文本，内容较大，一定要创建前缀索引。</li>
<li>尽量使用复合索引，使用单列索引容易回表查询。</li>
<li>如果一个字段中的数据不会为NULL，建议建表时添加not null约束，这样优化器就知道使用哪个索引列更加有效。</li>
<li>不要创建太多索引，当对数据进行增删改的时候，索引需要重新重新排序。</li>
<li>如果很少的查询，经常的增删改不建议加索引。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=jEYBE&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h2 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h2><h3 id="order-by的优化"><a href="#order-by的优化" class="headerlink" title="order by的优化"></a>order by的优化</h3><p>准备数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> workers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> workers(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  age <span class="type">int</span>,</span><br><span class="line">  sal <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;孙悟空&#x27;</span>, <span class="number">500</span>, <span class="number">50000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;猪八戒&#x27;</span>, <span class="number">300</span>, <span class="number">40000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;沙和尚&#x27;</span>, <span class="number">600</span>, <span class="number">40000</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> workers <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;白骨精&#x27;</span>, <span class="number">600</span>, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<p>explain查看一个带有order by的语句时，Extra列会显示：using index 或者 using filesort，区别是什么？</p>
<ul>
<li>using index:  表示使用索引，因为索引是提前排好序的。效率很高。</li>
<li>using filesort：表示使用文件排序，这就表示没有走索引，对表中数据进行排序，排序时将硬盘的数据读取到内存当中，在内存当中排好序。这个效率是低的，应避免。</li>
</ul>
<p>此时name没有添加索引，如果根据name进行排序的话：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,name <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709781082541-862ac81e-9a79-4e31-9514-35e97a39279b.png#averageHue=%23f2f1f1&clientId=u35b840e1-8af8-4&from=paste&height=81&id=ufe7325b8&originHeight=81&originWidth=1483&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6475&status=done&style=shadow&taskId=udb902c9b-42b3-4d03-9fec-0e3293b182a&title=&width=1483" alt="image.png"><br>显然这种方式效率较低。<br>给name添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_name <span class="keyword">on</span> workers(name);</span><br></pre></td></tr></table></figure>

<p>再根据name排序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,name <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709781158431-68a613c1-33d6-46d0-a14b-e0cb855b8681.png#averageHue=%23f3f2f2&clientId=u35b840e1-8af8-4&from=paste&height=85&id=u1d6061b5&originHeight=85&originWidth=1483&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6486&status=done&style=shadow&taskId=u0cf01012-9c92-472c-ac19-31e967efdcd&title=&width=1483" alt="image.png"><br>这样效率则提升了。</p>
<p>如果要通过age和sal两个字段进行排序，最好给age和sal两个字段添加复合索引，不添加复合索引时：<br>按照age升序排，如果age相同则按照sal升序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709781464653-7d4b762b-70da-409d-a8cc-1026f425ad48.png#averageHue=%23f3f2f1&clientId=u35b840e1-8af8-4&from=paste&height=84&id=ueb311e95&originHeight=84&originWidth=1488&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6279&status=done&style=shadow&taskId=u5de7a94b-04b7-41db-a2b8-250f3b9eecc&title=&width=1488" alt="image.png"><br>这样效率是低的。<br>给age和sal添加复合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_age_sal <span class="keyword">on</span> workers(age, sal);</span><br></pre></td></tr></table></figure>

<p>再按照age升序排，如果age相同则按照sal升序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709781624043-82823844-ebeb-41cc-8fcb-27a8967e9eea.png#averageHue=%23f4f3f2&clientId=u35b840e1-8af8-4&from=paste&height=91&id=u8383b4b8&originHeight=91&originWidth=1479&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5966&status=done&style=shadow&taskId=ucf411262-97b5-451c-9436-fffb9572004&title=&width=1479" alt="image.png"><br>这样效率提升了。</p>
<p>在B+树上叶子结点上的所有数据默认是按照升序排列的，如果按照age降序，如果age相同则按照sal降序，会走索引吗？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">desc</span>,sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709781795115-c94583df-3766-4d80-a4f7-8af913d4b0a9.png#averageHue=%23cda567&clientId=u35b840e1-8af8-4&from=paste&height=94&id=u9974ad4c&originHeight=94&originWidth=1425&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7558&status=done&style=shadow&taskId=u6f9dd59d-cca6-40ca-9e74-bb7ead187cb&title=&width=1425" alt="image.png"><br>可以看到备注信息是：反向索引扫描，使用了索引。<br>这样效率也是很高的，因为B+树叶子结点之间采用的是双向指针。可以从左向右（升序），也可以从右向左（降序）。</p>
<p>如果一个升序，一个降序会怎样呢？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782038074-ee34a154-581b-4dd2-9168-5e9cbf762b05.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=86&id=u80038654&originHeight=86&originWidth=1329&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6775&status=done&style=shadow&taskId=ub7395e16-2a46-42e5-8ef4-57f82dac0cd&title=&width=1329" alt="image.png"><br>可见age使用了索引，但是sal没有使用索引。怎么办呢？可以针对这种排序情况创建对应的索引来解决：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_workers_ageasc_saldesc <span class="keyword">on</span> workers(age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>);</span><br></pre></td></tr></table></figure>

<p>创建的索引如下：A表示升序，D表示降序。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782274642-1cb28544-576c-4c7f-9c0c-cbaaacc9ae6e.png#averageHue=%23f9f7f6&clientId=u35b840e1-8af8-4&from=paste&height=326&id=ue295817c&originHeight=326&originWidth=1504&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27858&status=done&style=shadow&taskId=uf94fe3cb-751c-47e2-b82a-87f5ceb807a&title=&width=1504" alt="image.png"><br>再次执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782153009-a74b6d7f-b41e-4654-b068-ad5749dbb098.png#averageHue=%23f2f1f1&clientId=u35b840e1-8af8-4&from=paste&height=87&id=u37610f47&originHeight=87&originWidth=1256&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6076&status=done&style=shadow&taskId=u637d549c-e66e-4ea6-99c1-16443b9b7a6&title=&width=1256" alt="image.png"></p>
<p>我们再来看看，对于排序来说是否支持最左前缀法则：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> id,age,sal <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782435845-ace755ba-8ab0-4330-93ed-3bf5e82a4ed2.png#averageHue=%23f3f2f1&clientId=u35b840e1-8af8-4&from=paste&height=85&id=u453e6be7&originHeight=85&originWidth=1303&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6165&status=done&style=shadow&taskId=u4788f1ec-9cc1-47a3-9a5d-22d93fedbfb&title=&width=1303" alt="image.png"><br>通过测试得知，order by也遵循最左前缀法则。</p>
<p>我们再来看一下未使用覆盖索引会怎样？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> workers <span class="keyword">order</span> <span class="keyword">by</span> age,sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782521969-56b24557-9c9f-4077-a82c-c929e92a0129.png#averageHue=%23f4f3f3&clientId=u35b840e1-8af8-4&from=paste&height=95&id=u17bd9104&originHeight=95&originWidth=1265&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6021&status=done&style=shadow&taskId=u4f6e9fdb-a00c-4333-8c5e-d97acfe370f&title=&width=1265" alt="image.png"><br>通过测试得知，排序也要尽量使用覆盖索引。</p>
<p>order by 优化原则总结：</p>
<ol>
<li>排序也要遵循最左前缀法则。</li>
<li>使用覆盖索引。</li>
<li>针对不同的排序规则，创建不同索引。（如果所有字段都是升序，或者所有字段都是降序，则不需要创建新的索引）</li>
<li>如果无法避免filesort，要注意排序缓存的大小，默认缓存大小256KB，可以修改系统变量 sort_buffer_size ：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;sort_buffer_size&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709782782925-0ec340e2-d15c-4296-86ac-250568c46dc0.png#averageHue=%23dfdedc&clientId=u35b840e1-8af8-4&from=paste&height=60&id=u3e96e4a4&originHeight=60&originWidth=223&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2489&status=done&style=shadow&taskId=uec6668b2-9aa8-4155-a6ec-9659492ecf8&title=&width=223" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=vAP7B&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="group-by优化"><a href="#group-by优化" class="headerlink" title="group by优化"></a>group by优化</h3><p>创建empx表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> empx <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<p>job字段上没有索引，根据job进行分组，查看每个工作岗位有多少人：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783194871-ebac7b79-ccdc-455c-8166-2fd36e833d71.png#averageHue=%23efedec&clientId=u35b840e1-8af8-4&from=paste&height=148&id=u8fe3bc16&originHeight=148&originWidth=201&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4412&status=done&style=shadow&taskId=u0ffbae4e-d414-4573-83d7-508901a8853&title=&width=201" alt="image.png"><br>看看是否走索引了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783226523-4ad14ecb-039e-4538-8b7c-574b71294dfb.png#averageHue=%23f3f2f1&clientId=u35b840e1-8af8-4&from=paste&height=89&id=u4ee51c14&originHeight=89&originWidth=1248&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5983&status=done&style=shadow&taskId=uf09e69c3-4d14-4012-89fa-5610caa5f15&title=&width=1248" alt="image.png"><br>使用了临时表，效率较低。</p>
<p>给job添加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_empx_job <span class="keyword">on</span> empx(job);</span><br></pre></td></tr></table></figure>

<p>再次执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> job,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783325987-ccb3c7a5-232d-4d7b-aea2-5065f2c6ce43.png#averageHue=%23f4f2f2&clientId=u35b840e1-8af8-4&from=paste&height=96&id=u18ff7284&originHeight=96&originWidth=1258&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5984&status=done&style=shadow&taskId=u7c785f8b-ab5d-4671-91cf-7bd81a5a98e&title=&width=1258" alt="image.png"><br>效率提升了。</p>
<p>我们再来看看group by是否需要遵守最左前缀法则：给deptno和sal添加复合索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_empx_deptno_sal <span class="keyword">on</span> empx(deptno, sal);</span><br></pre></td></tr></table></figure>

<p>根据部门编号分组，查看每个部门人数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> deptno,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783498550-a5bd4f3e-3167-474e-81d3-54ca8b7ab90e.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=85&id=u3d6add83&originHeight=85&originWidth=1279&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5921&status=done&style=shadow&taskId=u29487fbc-dee7-4e98-b993-b15a24a38aa&title=&width=1279" alt="image.png"><br>效率很高，因为deptno是复合索引中最左边的字段。<br>根据sal分组，查看每个工资有多少人：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> sal, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">group</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783567910-aaa709cf-edd2-4827-bfe5-59bd4d939e20.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=86&id=uf812a6fe&originHeight=86&originWidth=1336&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6456&status=done&style=shadow&taskId=u2f89bd10-af35-474f-9310-d9112de2966&title=&width=1336" alt="image.png"><br>使用了临时表，效率较低。<br>通过测试得知，group by也同样遵循最左前缀法则。</p>
<p>我们再来测试一下，如果将部门编号deptno（复合索引的最左列）添加到where条件中，效率会不会提升：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> sal, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> empx <span class="keyword">where</span> deptno<span class="operator">=</span><span class="number">10</span> <span class="keyword">group</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709783791088-acd69751-3ef3-4bb4-a86c-80734281920f.png#averageHue=%23f2f1f0&clientId=u35b840e1-8af8-4&from=paste&height=82&id=u9ea99fa9&originHeight=82&originWidth=1270&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6278&status=done&style=shadow&taskId=uac239529-cb8b-4c88-a8a8-bbc3b004efa&title=&width=1270" alt="image.png"><br>效率有提升的，这说明了，group by确实也遵循最左前缀法则。（where中使用了最左列）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=W2qul&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="limit优化"><a href="#limit优化" class="headerlink" title="limit优化"></a>limit优化</h3><p>数据量特别庞大时，取数据时，越往后效率越低，怎么提升？mysql官方给出的解决方案是：使用覆盖索引+子查询的形式来提升效率。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709792419459-85a3ad86-c141-426c-b9de-6dc7469d60ee.png#averageHue=%23151211&clientId=u35b840e1-8af8-4&from=paste&height=634&id=u51e2988a&originHeight=634&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61566&status=done&style=shadow&taskId=uc68032bd-7849-4c40-bdb3-c234b55b01b&title=&width=921" alt="image.png"></p>
<p>怎么解决？使用覆盖索引，加子查询<br>使用覆盖索引：速度有所提升<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709792480566-96befb8b-95c5-498a-b6ca-fa813ed527c2.png#averageHue=%23100e0e&clientId=u35b840e1-8af8-4&from=paste&height=219&id=ub9c7ece1&originHeight=219&originWidth=723&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10161&status=done&style=shadow&taskId=ue75ff2e1-1f52-455e-ad48-7db2b74f010&title=&width=723" alt="image.png"><br>使用子查询形式取其他列的数据：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709792539686-fc91c8b7-31c3-4d86-acd5-13355ec2af34.png#averageHue=%23121110&clientId=u35b840e1-8af8-4&from=paste&height=202&id=uc374a206&originHeight=202&originWidth=1269&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21977&status=done&style=shadow&taskId=u9ba6a9b3-13b3-44c2-9d69-a2c2292684b&title=&width=1269" alt="image.png"><br>通过测试，这种方式整体效率有所提升。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=LKwpI&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="主键优化"><a href="#主键优化" class="headerlink" title="主键优化"></a>主键优化</h3><p>主键设计原则：</p>
<ol>
<li>主键值不要太长，二级索引叶子结点上存储的是主键值，主键值太长，容易导致索引占用空间较大。</li>
<li>尽量使用auto_increment生成主键。尽量不要使用uuid做主键，因为uuid不是顺序插入。</li>
<li>最好不要使用业务主键，因为业务的变化会导致主键值的频繁修改，主键值不建议修改，因为主键值修改，聚集索引一定会重新排序。</li>
<li>在插入数据时，主键值最好是顺序插入，不要乱序插入，因为乱序插入可能会导致B+树叶子结点频繁的进行页分裂与页合并操作，效率较低。<ol>
<li>主键值对应聚集索引，插入主键值如果是乱序的，B+树叶子结点需要不断的重新排序，重排过程中还会频繁涉及到<strong>页分裂和页合并</strong>的操作，效率较低。</li>
<li>B+树上的每个节点都存储在页（page）中。一个页面中存储一个节点。</li>
<li>MySQL的InnoDB存储引擎一个页可以存储16KB的数据。</li>
<li>如果主键值不是顺序插入的话，会导致频繁的页分裂和页合并。在一个B+树中，页分裂和页合并是树的自动调整机制的一部分。当一个页已经满了，再插入一个新的关键字时就会触发页分裂操作，将页中的关键字分配到两个新的页中，同时调整树的结构。相反，当一个页中的关键字数量下降到一个阈值以下时，就会触发页合并操作，将两个相邻的页合并成一个新的页。如果主键值是随机的、不是顺序插入的，那么页的利用率会降低，页分裂和页合并的次数就会增加。由于页的分裂和合并是比较耗时的操作，频繁的分裂和合并会降低数据库系统的性能。因此，为了优化B+树的性能，可以将主键值设计成顺序插入的，这样可以减少页的分裂和合并的次数，提高B+树的性能。在实际应用中，如果对主键值的顺序性能要求不是特别高，也可以采用一些技术手段来减少页分裂和合并，例如B+树分裂时采用“延迟分裂”技术，或者通过调整页的大小和节点的大小等方式来优化B+树的性能。</li>
</ol>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/21376908/1709779279973-956a0695-45ff-472d-bc49-20db1031cc9e.jpeg#averageHue=%23ece6c8&clientId=u35b840e1-8af8-4&from=paste&height=442&id=u860d200d&originHeight=2000&originWidth=3020&originalType=binary&ratio=1&rotation=0&showTitle=false&size=344186&status=done&style=shadow&taskId=ue57bddc9-90d5-4461-8e1d-a0334ed7b70&title=&width=667" alt="1.jpg"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=pG60h&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="insert优化"><a href="#insert优化" class="headerlink" title="insert优化"></a>insert优化</h3><p>insert优化原则：</p>
<ul>
<li>批量插入：数据量较大时，不要一条一条插入，可以批量插入，当然，建议一次插入数据不超过1000条</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_user(id,name,age) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="number">20</span>),(<span class="number">2</span>,<span class="string">&#x27;lucy&#x27;</span>,<span class="number">30</span>),(<span class="number">3</span>,<span class="string">&#x27;timi&#x27;</span>,<span class="number">22</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>mysql默认是自动提交事务，只要执行一条DML语句就自动提交一次，因此，当插入大量数据时，建议手动开启事务和手动提交事务。不建议使用数据库事务自动提交机制。</li>
<li>主键值建议采用顺序插入，顺序插入比乱序插入效率高。</li>
<li>超大数据量插入可以考虑使用mysql提供的load指令，load指令可以将csv文件中的数据批量导入到数据库表当中，并且效率很高，过程如下：<ul>
<li>第一步：登录mysql时指定参数</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="comment">--local-infile -uroot -p1234</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：开启local_infile功能</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> local_infile <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：执行load指令</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use powernode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_temp(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  password <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  birth <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">  email <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> infile <span class="string">&#x27;E:\\powernode\\05-MySQL高级\\resources\\t_temp-100W.csv&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> t_temp fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>文件中的数据如下：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709775730313-08bbfff2-f309-48c1-8a0b-8f35199ea26b.png#averageHue=%23e4e0db&clientId=u487a63fb-d269-4&from=paste&height=124&id=u682f5f56&originHeight=124&originWidth=721&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15197&status=done&style=shadow&taskId=ube19aa54-7d7f-4be2-993b-142cfdc94b5&title=&width=721" alt="image.png"></p>
<p>导入表中之后，数据如下：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709775744254-1cec3fef-c141-47d2-9b63-fecfda8dc360.png#averageHue=%23171513&clientId=u487a63fb-d269-4&from=paste&height=211&id=ud57abe6c&originHeight=211&originWidth=824&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26037&status=done&style=shadow&taskId=u800e80b7-21a0-4ae8-89a4-a843171b036&title=&width=824" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=IlK7w&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="count-优化"><a href="#count-优化" class="headerlink" title="count(*)优化"></a>count(*)优化</h3><p>分组函数count的使用方式：</p>
<ul>
<li>count(主键)<ul>
<li>原理：将每个主键值取出，累加</li>
</ul>
</li>
<li>count(常量值)<ul>
<li>原理：获取到每个常量值，累加</li>
</ul>
</li>
<li>count(字段)<ul>
<li>原理：取出字段的每个值，判断是否为NULL，不为NULL则累加。</li>
</ul>
</li>
<li>count(*)<ul>
<li>原理：不用取值，底层mysql做了优化，直接统计总行数，效率最高。</li>
</ul>
</li>
</ul>
<p>结论：如果你要统计一张表中数据的总行数，建议使用 count(*)</p>
<p>注意：</p>
<ul>
<li>对于InnoDB存储引擎来说，count计数的实现原理就是将表中每一条记录取出，然后累加。如果你想真正提高效率，可以自己使用额外的其他程序来实现，例如每向表中插入一条记录时，在redis数据库中维护一个总行数，这样获取总行数的时候，直接从redis中获取即可，这样效率是最高的。</li>
<li>对于MyISAM存储引擎来说，当一个select语句没有where条件时，获取总行数效率是极高的，不需要统计，因为MyISAM存储引擎维护了一个单独的总行数。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/21376908/1692002570088-3338946f-42b3-4174-8910-7e749c31e950.jpeg#averageHue=%23f9f8f8&from=url&id=pLGNf&originHeight=78&originWidth=1400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&title="></p>
<h3 id="update优化"><a href="#update优化" class="headerlink" title="update优化"></a>update优化</h3><p>当存储引擎是InnoDB时，表的行级锁是针对索引添加的锁，如果索引失效了，或者不是索引列时，会提升为表级锁。<br>什么是行级锁？A事务和B事务，开启A事务后，通过A事务修改表中某条记录，修改后，在A事务未提交的前提下，B事务去修改同一条记录时，无法继续，直到A事务提交，B事务才可以继续。</p>
<p>有一张表：t_fruit</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_fruit(</span><br><span class="line">  id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;苹果&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;香蕉&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_fruit <span class="keyword">values</span>(<span class="keyword">null</span>, <span class="string">&#x27;橘子&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>开启A事务和B事务，演示行级锁：<br>事务A没有结束之前，事务B卡住：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709801809111-e793cdbb-8831-4a09-8ed2-c59a06c059b7.png#averageHue=%23343332&clientId=u35b840e1-8af8-4&from=paste&height=262&id=u334dda64&originHeight=262&originWidth=1317&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37438&status=done&style=shadow&taskId=u61a2bedb-5248-4796-9afe-78c03eabfa2&title=&width=1317" alt="image.png"><br>事务A结束之后，事务B继续执行：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709801868506-53ecc7e3-4b12-4f17-9842-e4e073e48dc8.png#averageHue=%232c2b2a&clientId=u35b840e1-8af8-4&from=paste&height=333&id=u6e51fb46&originHeight=333&originWidth=1283&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50480&status=done&style=shadow&taskId=uc9936036-1805-447c-85cd-e6ae35f8ff9&title=&width=1283" alt="image.png"><br>当然，如果更新的不是同一行数据，事务A和事务B可以并发：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709802096461-f9ab6622-48f9-4e19-8773-f31ef8728303.png#averageHue=%232a2928&clientId=u35b840e1-8af8-4&from=paste&height=328&id=u0ba90557&originHeight=328&originWidth=1279&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49283&status=done&style=shadow&taskId=u7c4d7d00-1f15-4fca-866e-c68b3b49999&title=&width=1279" alt="image.png"></p>
<p>行级锁是对索引列加锁，以上更新语句的where条件是id，id是主键，当然有索引，所以使用了行级锁，如果索引失效，或者字段上没有索引，则会升级为表级锁：<br><img src="https://cdn.nlark.com/yuque/0/2024/png/21376908/1709802244610-ba45b78f-f8b7-445a-af7d-f5d8ad44441f.png#averageHue=%232f2e2d&clientId=u35b840e1-8af8-4&from=paste&height=285&id=u0540d10d&originHeight=285&originWidth=1388&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35657&status=done&style=shadow&taskId=u0eb965eb-c2c4-43f1-9bd1-602b94111e5&title=&width=1388" alt="image.png"></p>
<p>因此，为了更新的效率，建议update语句中where条件中的字段是添加索引的。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post-share"><div class="social-share" data-image="/image/icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/06/04/JDBC/" title="JDBC"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">JDBC</div></div><div class="info-2"><div class="info-item-1">一、概述Java DataBase Connectivity ： Java 数据库连接 Java语言操作关系型数据库的一套规则（接口），各个数据库厂商去实现这套接口，提供数据库驱动jar包。真正执行的代码是驱动包中的实现类。 JDBC的好处：各数据库使用相同的接口，Java代码不需要针对不同数据库分别开发。可随时替换底层数据库，访问数据库的Java代码基本不变。  二、DriverManager注册驱动1Class.forName(&quot;com.mysql.jdbc.Driver&quot;);  Driver类源码中含有静态代码块，静态代码块中直接就初始化驱动对象了。  注：MySQL5之后的驱动包，可以省略注册驱动这一步。 获取连接 参数：  Connection获取执行SQL的statement对象普通执行SQL对象Statement createStatement() 预编译SQL的执行SQL对象：防止SQL注入PreparedStatement prepareStatement(sql) 执行存储过程的对象CallableStatement...</div></div></div></a><a class="pagination-related" href="/2025/05/25/mysql%E5%88%9D%E7%BA%A7/" title="mysql 初级"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">mysql 初级</div></div><div class="info-2"><div class="info-item-1">第一步操作 以管理员身份运行cmd，输入net start mysql 运行mysql 在cmd中输入mysql -h[地址] -P[端口] -u[用户名] -p[密码]  （使用本机的mysql数据库时，可以省略地址和端口）  MySQL命令行基本命令  列出当前数据库管理系统中有哪些数据库。  1show databases;    创建数据库，起名bjpowernode。  1create database bjpowernode;    使用bjpowernode数据库。  1use bjpowernode;    查看当前用的是哪个数据库。  1select database();    查看当前数据库中有哪些表。  1show tables;    删除数据库bjpowernode。  1drop database bjpowernode;    退出mysql exit quit ctrl + c   查看当前mysql版本  1select version();  还可以使用mysql.exe命令来查看版本信息（在没有登录mysql之前使用）：mysql...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/05/25/mysql%E5%88%9D%E7%BA%A7/" title="mysql 初级"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-25</div><div class="info-item-2">mysql 初级</div></div><div class="info-2"><div class="info-item-1">第一步操作 以管理员身份运行cmd，输入net start mysql 运行mysql 在cmd中输入mysql -h[地址] -P[端口] -u[用户名] -p[密码]  （使用本机的mysql数据库时，可以省略地址和端口）  MySQL命令行基本命令  列出当前数据库管理系统中有哪些数据库。  1show databases;    创建数据库，起名bjpowernode。  1create database bjpowernode;    使用bjpowernode数据库。  1use bjpowernode;    查看当前用的是哪个数据库。  1select database();    查看当前数据库中有哪些表。  1show tables;    删除数据库bjpowernode。  1drop database bjpowernode;    退出mysql exit quit ctrl + c   查看当前mysql版本  1select version();  还可以使用mysql.exe命令来查看版本信息（在没有登录mysql之前使用）：mysql...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/image/icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">eric_zht</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/erichtz"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">第一个存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-text">存储过程的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-text">存储过程的调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="toc-text">存储过程的查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%A0%E9%99%A4"><span class="toc-text">存储过程的删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delimiter%E5%91%BD%E4%BB%A4"><span class="toc-text">delimiter命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">MySQL的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="toc-text">系统变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="toc-text">用户变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-text">局部变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#if%E8%AF%AD%E5%8F%A5"><span class="toc-text">if语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-text">参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#case%E8%AF%AD%E5%8F%A5"><span class="toc-text">case语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#while%E5%BE%AA%E7%8E%AF"><span class="toc-text">while循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#repeat%E5%BE%AA%E7%8E%AF"><span class="toc-text">repeat循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loop%E5%BE%AA%E7%8E%AF"><span class="toc-text">loop循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87cursor"><span class="toc-text">游标cursor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E6%8D%89%E5%BC%82%E5%B8%B8%E5%B9%B6%E5%A4%84%E7%90%86"><span class="toc-text">捕捉异常并处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="toc-text">存储函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-text">触发器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E6%94%AF%E6%8C%81%E5%93%AA%E4%BA%9B%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">MySQL支持哪些存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%92%8C%E4%BF%AE%E6%94%B9%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">指定和修改存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">指定存储引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">修改存储引擎</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%8F%8A%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">常用的存储引擎及适用场景</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%B4%A2%E5%BC%95"><span class="toc-text">什么是索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4"><span class="toc-text">索引的创建和删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-text">主键会自动添加索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unique%E7%BA%A6%E6%9D%9F%E7%9A%84%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-text">unique约束的字段自动添加索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E6%8C%87%E5%AE%9A%E7%9A%84%E5%AD%97%E6%AE%B5%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-text">给指定的字段添加索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E4%B8%8A%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-text">删除指定字段上的索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9F%90%E5%BC%A0%E8%A1%A8%E4%B8%8A%E6%B7%BB%E5%8A%A0%E4%BA%86%E5%93%AA%E4%BA%9B%E7%B4%A2%E5%BC%95"><span class="toc-text">查看某张表上添加了哪些索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text">索引的分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E7%B4%A2%E5%BC%95%E9%87%87%E7%94%A8%E4%BA%86B-%E6%A0%91%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">MySQL索引采用了B+树数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8F%89%E6%A0%91"><span class="toc-text">二叉树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A2%E9%BB%91%E6%A0%91%EF%BC%88%E8%87%AA%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91%EF%BC%89"><span class="toc-text">红黑树（自平衡二叉树）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Trees%EF%BC%88B%E6%A0%91%EF%BC%89"><span class="toc-text">B Trees（B树）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Trees%EF%BC%88B-%E6%A0%91%EF%BC%89"><span class="toc-text">B+ Trees（B+ 树）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%B4%A2%E5%BC%95%E5%8F%8A%E7%9B%B8%E5%85%B3%E8%B0%83%E4%BC%98"><span class="toc-text">其他索引及相关调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash%E7%B4%A2%E5%BC%95"><span class="toc-text">Hash索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95"><span class="toc-text">聚集索引和非聚集索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95"><span class="toc-text">二级索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-text">覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="toc-text">索引下推</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95%EF%BC%88%E5%8D%95%E4%B8%80%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-text">单列索引（单一索引）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%EF%BC%88%E7%BB%84%E5%90%88%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-text">复合索引（组合索引）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">索引的优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-text">何时用索引</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E4%BC%98%E5%8C%96"><span class="toc-text">MySQL优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5"><span class="toc-text">MySQL优化手段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-text">SQL性能分析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B4%E4%BD%93%E6%83%85%E5%86%B5"><span class="toc-text">查看数据库整体情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">慢查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show-profiles"><span class="toc-text">show profiles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#explain"><span class="toc-text">explain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#id"><span class="toc-text">id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select-type"><span class="toc-text">select_type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table"><span class="toc-text">table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type"><span class="toc-text">type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#possible-keys"><span class="toc-text">possible_keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key"><span class="toc-text">key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key-len"><span class="toc-text">key_len</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rows"><span class="toc-text">rows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extra"><span class="toc-text">Extra</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E7%B4%A2%E5%BC%95-vs-%E4%B8%8D%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="toc-text">加索引 vs 不加索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E5%8E%9F%E5%88%99"><span class="toc-text">最左前缀原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5"><span class="toc-text">索引失效情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%97%E5%8F%82%E5%8A%A0%E4%BA%86%E8%BF%90%E7%AE%97%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">索引列参加了运算，索引失效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%97%E8%BF%9B%E8%A1%8C%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E6%97%B6%E4%BB%A5-%E5%BC%80%E5%A7%8B%E7%9A%84%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">索引列进行模糊查询时以 % 开始的，索引失效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%97%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B%EF%BC%8C%E4%BD%86%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%9C%81%E7%95%A5%E4%BA%86%E5%8D%95%E5%BC%95%E5%8F%B7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">索引列是字符串类型，但查询时省略了单引号，索引失效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%E4%B8%AD%E6%9C%89or%EF%BC%8C%E5%8F%AA%E8%A6%81%E6%9C%89%E6%9C%AA%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">查询条件中有or，只要有未添加索引的字段，索引失效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%93%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AE%B0%E5%BD%95%E5%9C%A8%E8%A1%A8%E4%B8%AD%E5%8D%A0%E6%AF%94%E8%BE%83%E5%A4%A7%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">当查询的符合条件的记录在表中占比较大，索引失效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eis-null%E5%92%8Cis-not-null%E7%9A%84%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-text">关于is null和is not null的索引失效问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95"><span class="toc-text">指定索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95-1"><span class="toc-text">覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="toc-text">前缀索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95%E5%92%8C%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E6%80%8E%E4%B9%88%E9%80%89%E6%8B%A9"><span class="toc-text">单列索引和复合索引怎么选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA%E5%8E%9F%E5%88%99"><span class="toc-text">索引创建原则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E4%BC%98%E5%8C%96"><span class="toc-text">SQL优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#order-by%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-text">order by的优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group-by%E4%BC%98%E5%8C%96"><span class="toc-text">group by优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit%E4%BC%98%E5%8C%96"><span class="toc-text">limit优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E4%BC%98%E5%8C%96"><span class="toc-text">主键优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E4%BC%98%E5%8C%96"><span class="toc-text">insert优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#count-%E4%BC%98%E5%8C%96"><span class="toc-text">count(*)优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update%E4%BC%98%E5%8C%96"><span class="toc-text">update优化</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/02/app_class_2025_sum/exp4/" title="移动软件开发 实验4：口述校史">移动软件开发 实验4：口述校史</a><time datetime="2025-09-01T16:00:00.000Z" title="发表于 2025-09-02 00:00:00">2025-09-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/01/app_class_2025_sum/exp3/" title="移动软件开发 实验3：微信小程序云开发">移动软件开发 实验3：微信小程序云开发</a><time datetime="2025-08-31T16:00:00.000Z" title="发表于 2025-09-01 00:00:00">2025-09-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/26/app_class_2025_sum/exp2/" title="移动软件开发 实验2：天气查询小程序">移动软件开发 实验2：天气查询小程序</a><time datetime="2025-08-25T16:00:00.000Z" title="发表于 2025-08-26 00:00:00">2025-08-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/25/app_class_2025_sum/exp1/" title="移动软件开发 实验1：第一个微信小程序">移动软件开发 实验1：第一个微信小程序</a><time datetime="2025-08-24T16:00:00.000Z" title="发表于 2025-08-25 00:00:00">2025-08-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/Redis/" title="Redis">Redis</a><time datetime="2025-07-23T16:00:00.000Z" title="发表于 2025-07-24 00:00:00">2025-07-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://pic.imgdb.cn/item/6741310cd29ded1a8c7a7799.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By eric_zht</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>